<!DOCTYPE html>
<!--
  STOCKED | Meal Planner (Single-File App)

  File organization (high level):
  1) <head>
     - Meta + favicon
     - Global CSS (base + components + modals)
  2) <body>
     - App shell (nav, tabs, panels)
     - Reusable modals (confirm, alerts, cook mode, week view, etc.)
  3) <script type="module">
/* =====================================================================
   JAVASCRIPT MODULE OVERVIEW (Single-file app)

   Sections (use editor search for the header text):
   1) Firebase setup (Auth + Firestore)
   2) Global state (recipes, meal plan, inventory, UI selections)
   3) UI utilities (toasts, modals, formatting helpers)
   4) Recipes (CRUD, import/scrape, scaling, print)
   5) Planner (week grid, assign recipes, clear week)
   6) Grocery + Inventory (generate list, match pantry items)
   7) Cook Mode (full-screen checklist + step timers)
   8) View Week (modal with deduped recipe cards + day filter)
   9) Initialization (auth listeners, first render)

   Tip: Keep functional changes small and test after each edit.
   ===================================================================== */

     - Firebase setup (auth + Firestore)
     - Global state + helpers
     - Feature modules (Recipes, Planner, Grocery, Inventory, Cook Mode, Week View)
     - Event wiring / initialization

  Notes:
  - This project intentionally keeps everything in one HTML file for easy copy/paste deployment.
  - Major features are separated in the JS by section headers.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stocked | Meal Planner</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%235C8D89' d='M96 0C60.7 0 32 28.7 32 64V96c0 16.4 6.1 31.4 16.2 43.2C40.3 151.1 35.1 164.5 33 179c-3.7 26.3 15.1 50.7 41.5 54.4l5.5 .8V384c0 70.7 57.3 128 128 128h160c70.7 0 128-57.3 128-128V234.2l5.5-.8c26.3-3.7 45.1-28 41.5-54.4c-2.1-14.5-7.3-27.9-15.2-39.8C473.9 127.4 480 112.4 480 96V64c0-35.3-28.7-64-64-64H96zM416 96H96V64h320v32zM96 384V219.8l-10.8-7.2c-10.8-7.2-16.4-20.2-14.3-33c2.2-13.1 13.5-22.6 26.8-22.6H414.3c13.3 0 24.6 9.5 26.8 22.6c2.2 12.8-3.5 25.8-14.3 33l-10.8 7.2V384c0 35.3-28.7 64-64 64H160c-35.3 0-64-28.7-64-64z'/%3E%3C/svg%3E">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
/* =====================================================================
   GLOBAL STYLESHEET (Single-file app)
   - Base tokens (colors, spacing, typography)
   - Layout (app shell, panels, grids)
   - Components (buttons, cards, pills, inputs)
   - Modals & overlays (including Cook Mode + View Week)
   ===================================================================== */

        :root {
            --bg-color: #F9F7F2;
            --card-bg: #FFFFFF;
            --nav-bg: rgba(249, 247, 242, 0.95);
            --primary: #5C8D89;
            --primary-dark: #416B67;
            --accent: #D97D5D;
            --text-main: #2C3333;
            --text-light: #7E8A8A;
            --danger: #e74c3c;
            --border-radius: 16px;
            --shadow: 0 8px 24px rgba(44, 51, 51, 0.06);
            --border: 1px solid #E6E2DA;
            --input-bg: #FFFFFF;
            --slot-bg: #F7F5F0;
            --hover-bg: #EBE8E0;
            --scroll-track: #f1f1f1;
            --scroll-thumb: #c1c1c1;
            --bottom-nav-height: 70px;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --card-bg: #1E1E1E;
            --nav-bg: rgba(18, 18, 18, 0.95);
            --primary: #5C8D89;
            --primary-dark: #4A7A76;
            --accent: #E08E70;
            --text-main: #E0E0E0;
            --text-light: #A0A0A0;
            --danger: #ff6b6b;
            --shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            --border: 1px solid #333333;
            --input-bg: #2C2C2C;
            --slot-bg: #252525;
            --hover-bg: #333333;
            --scroll-track: #2a2a2a;
            --scroll-thumb: #555;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            font-family: 'Inter', sans-serif; 
            padding-bottom: 80px;
            line-height: 1.5;
            transition: background-color 0.3s, color 0.3s;
        }

        h1, h2, h3, .nav-brand, .recipe-title, .cook-title, .auth-title, .confirm-title {
            font-family: 'DM Serif Display', serif;
            letter-spacing: 0.5px;
        }

        /* --- DESKTOP NAV --- */
        nav {
            background: var(--nav-bg);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            backdrop-filter: blur(10px);
            transition: background 0.3s;
        }
        .nav-brand { font-size: 1.8rem; color: var(--text-main); display: flex; align-items: center; gap: 12px; }
        .nav-brand i { color: var(--primary); }
        
        .nav-center { display: flex; gap: 4px; background: var(--hover-bg); padding: 4px; border-radius: 30px; }
        .nav-tabs button {
            background: none; border: none; padding: 0.6rem 1.5rem; font-size: 0.9rem; font-weight: 600;
            cursor: pointer; color: var(--text-light); border-radius: 25px; transition: all 0.3s ease; font-family: 'Inter', sans-serif;
        }
        .nav-tabs button.active { background: var(--card-bg); color: var(--text-main); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        .nav-right { display: flex; align-items: center; gap: 0.5rem; position: relative; }
        .user-greeting { font-weight: 600; color: var(--primary); font-size: 0.95rem; display: none; margin-right: 1rem; }
        
        /* Unified Nav Icon Button Style */
        .nav-icon-btn { 
            background: none; border: none; cursor: pointer; color: var(--text-light); font-size: 1.2rem; 
            transition: 0.2s; padding: 8px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
        }
        .nav-icon-btn:hover { color: var(--primary); background: var(--hover-bg); }
        .nav-icon-btn.active { color: var(--primary); background: var(--hover-bg); box-shadow: inset 0 0 0 1px var(--primary); }
        
        /* --- MOBILE NAV BOTTOM BAR --- */
        .mobile-nav-bar {
            display: none; 
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--bottom-nav-height);
            background: var(--nav-bg); border-top: 1px solid var(--border);
            z-index: 900; justify-content: space-around; align-items: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }
        .mobile-nav-item {
            background: none; border: none; flex-direction: column; display: flex; align-items: center; justify-content: center;
            color: var(--text-light); font-size: 0.7rem; font-weight: 600; gap: 4px; cursor: pointer; flex: 1; height: 100%;
        }
        .mobile-nav-item i { font-size: 1.2rem; margin-bottom: 2px; }
        .mobile-nav-item.active { color: var(--primary); }

        /* --- SETTINGS DROPDOWN --- */
        .settings-dropdown {
            position: absolute; top: 120%; right: 0;
            background: var(--card-bg); border: var(--border); border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            width: 180px; display: none; flex-direction: column; overflow: hidden;
        }
        .settings-dropdown.show { display: flex; }
        
        .settings-item {
            padding: 12px 16px; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--text-main); transition: 0.2s;
        }
        .settings-item:hover { background: var(--hover-bg); color: var(--primary); }
        .settings-item.danger { color: var(--danger); border-top: 1px solid var(--border); }
        .settings-item.danger:hover { background: rgba(231, 76, 60, 0.1); }

        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1.5rem; }
        .page-section { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .page-section.active { display: block; opacity: 1; }

        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem; }
        .header-row h3, .header-row h2 { margin-bottom: 0; border: none; padding: 0; color: var(--text-main); }
        
        .btn-sm {
            padding: 0.4rem 0.8rem; font-size: 0.85rem; border-radius: 8px; border: 1px solid #D1D5DB; 
            background: var(--card-bg); color: var(--text-light); font-weight: 600; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; gap: 6px; font-family: 'Inter', sans-serif;
        }
        .btn-sm:hover { border-color: var(--primary); color: var(--primary); }
        .btn-sm i { font-size: 0.9rem; }

        input[type="text"], input[type="email"], input[type="password"], textarea, input[type="url"] {
            padding: 0.8rem 1rem; border: var(--border); border-radius: 8px; background: var(--input-bg); width: 100%; font-family: 'Inter', sans-serif; font-size: 0.95rem; transition: 0.2s; color: var(--text-main);
        }
        input:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(92, 141, 137, 0.1); }

        /* Search Bar Styles - UPDATED WIDTH (25%) */
        .search-row {
            display: flex; align-items: center; background: var(--input-bg);
            border: var(--border); border-radius: 50px; padding: 0.6rem 1.2rem;
            margin-bottom: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.02); transition: 0.2s;
            width: 25%; /* Force 1/4 width */
            min-width: 250px; /* Minimum width so it doesn't get too small */
        }
        .search-row:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(92, 141, 137, 0.1); }
        .search-row i.fa-search { color: var(--text-light); margin-right: 12px; font-size: 0.9rem;}
        .search-row input { 
            border: none; background: transparent; padding: 0; margin: 0; box-shadow: none; font-size: 1rem; flex-grow: 1;
        }
        .search-row input:focus { outline: none; box-shadow: none; border: none; }
        .btn-clear-search { background: none; border: none; color: var(--text-light); cursor: pointer; font-size: 0.9rem; padding: 4px; display: none; }
        .btn-clear-search:hover { color: var(--danger); }

        /* Dictation Styles */
        .input-wrapper { position: relative; width: 100%; }
        .mic-btn {
            position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
            background: none; border: none; font-size: 1.1rem; color: var(--text-light);
            cursor: pointer; transition: 0.2s; z-index: 5;
        }
        textarea + .mic-btn { top: 20px; transform: none; }
        .mic-btn:hover { color: var(--primary); transform: scale(1.1); }
        .mic-btn.listening { color: var(--danger); animation: pulse-red 1.5s infinite; }
        
        @keyframes pulse-red {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .input-wrapper textarea { padding-right: 40px; }
        .input-wrapper input { padding-right: 40px; }

        /* --- IMPORT ROW STYLES (New) --- */
        .import-row {
            display: flex; gap: 8px; background: var(--slot-bg); padding: 12px; border-radius: 12px; margin-bottom: 1.5rem; align-items: center; border: 1px dashed var(--border);
        }
        .import-row input { background: var(--card-bg); border: 1px solid var(--border); }
        .btn-import { background: var(--text-main); color: white; border:none; padding: 0 1.2rem; border-radius: 8px; height: 42px; font-weight: 600; white-space: nowrap; display: flex; align-items: center; gap: 6px; }
        .btn-import:hover { opacity: 0.9; }

        select { display: none; } 
        .custom-select-container { position: relative; width: 170px; font-family: 'Inter', sans-serif; font-size: 0.95rem; }
        .modal .custom-select-container { width: 100%; } 
        
        .select-selected { 
            background-color: var(--input-bg); border-radius: 8px; border: var(--border); padding: 0.8rem 1rem; 
            cursor: pointer; user-select: none; display: flex; justify-content: space-between; align-items: center; 
            transition: 0.2s; white-space: nowrap; overflow: hidden; color: var(--text-main);
        }
        .select-selected:after { 
            content: ""; width: 0.8em; height: 0.8em; 
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%235C8D89' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); 
            background-repeat: no-repeat; background-size: contain; background-position: center; 
            transform: rotate(0deg); transition: transform 0.2s; flex-shrink: 0; margin-left: 10px; 
        }
        .select-selected.select-arrow-active:after { transform: rotate(180deg); }
        .select-selected.select-arrow-active { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(92, 141, 137, 0.1); }
        
        .select-items { 
            position: absolute; background-color: var(--input-bg); top: 110%; left: 0; right: 0; z-index: 99; 
            border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); border: var(--border); 
            overflow: hidden; max-height: 250px; overflow-y: auto; 
        }
        .select-hide { display: none; }
        .select-items div { color: var(--text-main); padding: 0.8rem 1rem; cursor: pointer; border-bottom: 1px solid var(--border); transition: 0.1s; white-space: nowrap; }
        .select-items div:last-child { border-bottom: none; }
        .select-items div:hover, .same-as-selected { background-color: var(--primary); color: #ffffff; }

        .filter-row { display: flex; align-items: center; gap: 10px; margin-bottom: 1rem; }
        .filter-scroll { display: flex; gap: 0.8rem; overflow-x: auto; padding: 0.5rem 0 0.5rem 0; scrollbar-width: none; flex-grow: 1; }
        .filter-scroll::-webkit-scrollbar { display: none; }
        .filter-pill { background: var(--hover-bg); border: none; padding: 0.5rem 1.2rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; color: var(--text-light); white-space: nowrap; cursor: pointer; transition: 0.2s; }
        .filter-pill:hover { background: var(--border); }
        .filter-pill.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(92, 141, 137, 0.3); }
        .btn-manage-cats { background: none; border: none; cursor: pointer; color: var(--text-light); font-size: 1rem; padding: 8px; transition: 0.2s; border-radius: 50%; }
        .btn-manage-cats:hover { background: var(--hover-bg); color: var(--primary); }
        .recipe-count-badge { font-size: 0.85rem; color: var(--text-light); font-weight: 600; white-space: nowrap; margin-right: 8px; }

        .cat-list { list-style: none; margin-top: 1rem; }
        .cat-item { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; background: var(--input-bg); border: var(--border); border-radius: 8px; margin-bottom: 0.5rem; cursor: grab; transition: 0.2s; color: var(--text-main); }
        .cat-item:active { cursor: grabbing; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transform: scale(1.02); z-index: 10; }
        .cat-item.dragging { opacity: 0.5; background: var(--hover-bg); }
        .cat-grip { color: var(--text-light); margin-right: 10px; cursor: grab; }
        .cat-name { flex-grow: 1; font-weight: 500; display:flex; align-items:center; gap:8px;}
        .cat-delete { color: var(--text-light); cursor: pointer; padding: 5px; }
        .cat-delete:hover { color: var(--danger); }
        .cat-color-dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; flex-shrink:0; border: 1px solid rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; }
        .cat-color-dot:hover { transform: scale(1.3); }

        /* Color Picker Styles */
        .color-picker-row { display: flex; gap: 8px; margin-bottom: 1rem; flex-wrap: wrap; }
        .color-swatch { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
        .color-swatch:hover { transform: scale(1.2); }
        .color-swatch.selected { border-color: var(--text-main); box-shadow: 0 0 0 2px var(--card-bg), 0 0 0 4px var(--primary); }

        /* --- RECIPE CARD STYLES --- */
        .recipe-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 2rem; }
        .recipe-card { 
            background: var(--card-bg); 
            border-radius: var(--border-radius); 
            padding: 1.5rem; 
            border: var(--border); 
            box-shadow: var(--shadow); 
            position: relative; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); 
            display: flex; 
            flex-direction: column; 
            height: 400px; 
            overflow: hidden; 
            will-change: transform;
        }
        
        .recipe-card:hover { transform: translateY(-4px); box-shadow: 0 15px 35px rgba(0,0,0, 0.1); border-color: var(--primary); }

        .clickable-area { 
            cursor: pointer; 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
            position: relative;
        }

        .clickable-area::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: linear-gradient(transparent, var(--card-bg));
            pointer-events: none;
        }

        .recipe-details { font-size: 0.95rem; color: var(--text-light); margin-bottom: 0.5rem; }
        .recipe-details h4 { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.3rem; color: var(--text-main); opacity: 0.6; }
        .ingredient-list { margin-left: 1rem; margin-bottom: 0.5rem; line-height: 1.5; font-size: 0.9rem;}
        
        /* Updated to allow ordered lists */
        .instruction-preview { line-height: 1.6; }
        .instruction-preview ol { margin: 0; padding-left: 1.2rem; }
        
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
        .recipe-title { font-size: 1.4rem; color: var(--text-main); line-height: 1.2; }
        
        .cat-badges { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 0.5rem; }
        .cat-badge { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; padding: 4px 8px; border-radius: 6px; color: #333; background: #eee; display: inline-block; letter-spacing: 0.5px; }
        
        /* Multiplier Badge Styles */
        .multiplier-badge { display: flex; align-items: center; background: var(--slot-bg); border-radius: 20px; padding: 2px; border: 1px solid var(--border); font-size: 0.75rem; font-weight: 600; margin-left: 10px; color: var(--text-main); }
        .mult-btn { background: none; border: none; padding: 2px 8px; cursor: pointer; color: var(--text-light); font-weight: bold; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; transition:0.2s;}
        .mult-btn:hover { color: var(--primary); background: var(--hover-bg); border-radius: 50%; }
        .mult-val { min-width: 32px; text-align: center; font-variant-numeric: tabular-nums; }

        .fav-btn { background: none; border: none; cursor: pointer; color: #D1D5DB; font-size: 1.2rem; z-index: 2; transition: 0.2s;}
        .fav-btn:hover, .fav-btn.active { color: #f1c40f; }
        .card-actions { display: flex; gap: 0.5rem; justify-content: space-between; align-items: center; border-top: 1px dashed var(--border); padding-top: 1rem; margin-top: auto; }
        .action-buttons { display: flex; gap: 0.8rem; }
        .btn-icon { background: none; border: none; cursor: pointer; color: var(--text-light); font-size: 1rem; transition: 0.2s; z-index: 2;}
        .btn-icon:hover { color: var(--primary); transform: scale(1.1); }
        .btn-icon.delete:hover { color: var(--danger); }
        .btn-cook { background: var(--primary); color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: 0.2s; z-index: 2; }
        .btn-cook:hover { background: var(--primary-dark); }
        .expand-hint { font-size: 0.75rem; color: var(--text-light); transition: 0.3s; font-weight: 500; }

        /* --- UPDATED PLANNER GRID V.08 --- */
        .planner-grid { 
            display: flex; gap: 8px; overflow-x: auto; margin-bottom: 2.5rem; 
            background: var(--card-bg); padding: 1.5rem; 
            border-radius: var(--border-radius); box-shadow: var(--shadow); border: var(--border); 
        }
        
        .planner-labels-column { display: flex; flex-direction: column; min-width: 80px; gap:8px;}
        .day-column { flex: 1; min-width: 130px; display: flex; flex-direction: column; gap: 8px; }
        
        .day-header { font-family: 'DM Serif Display', serif; text-align: center; padding-bottom: 1rem; font-size: 1.1rem; color: var(--text-main); border-bottom: 2px solid var(--bg-color); margin-bottom: 0.5rem; min-height: 45px;}
        .meal-row-label { font-weight: 600; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-light); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; text-align: center; height: 90px; }
        .meal-row-label.small { height: 45px; } /* For dinner/side which are smaller */
        .meal-row-label i { font-size: 1.1rem; margin-bottom: 4px; color: var(--primary); opacity: 0.7; }
        
        .meal-slot { background: var(--slot-bg); border: 1px solid transparent; border-radius: 12px; height: 90px; padding: 4px; font-size: 0.8rem; position: relative; transition: 0.2s; cursor: pointer; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .meal-slot:hover { background: var(--hover-bg); }
        .meal-slot.drag-over { background: var(--hover-bg); border: 2px dashed var(--primary); }
        
        .meal-slot[data-type^="dinner"] { height: 45px; padding: 2px; }
        .meal-slot[data-type^="dinner"] .slot-placeholder { font-size: 0.8rem; }
        .slot-placeholder { color: var(--text-light); font-size: 1.1rem; pointer-events: none; transition: 0.2s; }
        .meal-slot:hover .slot-placeholder { color: var(--primary); transform: scale(1.2); }
        
        .planned-meal { background: var(--card-bg); padding: 6px 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); width: 100%; height: 100%; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--primary); cursor: default; font-weight: 500; font-size: 0.85rem; color: var(--text-main); }
        .meal-slot[data-type^="dinner"] .planned-meal { padding: 2px 8px; font-size: 0.75rem; border-radius: 6px; }
        .remove-meal { cursor: pointer; color: #D1D5DB; margin-left: 5px; transition: 0.2s;}
        .remove-meal:hover { color: var(--accent); }

        .tools-section { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .tool-card { background: var(--card-bg); padding: 2rem; border-radius: var(--border-radius); box-shadow: var(--shadow); display: flex; flex-direction: column; max-height: 650px; border: var(--border); }
        .tool-card h3 { font-size: 1.4rem; display: flex; align-items: center; gap: 10px; margin:0; color: var(--text-main); }
        .tool-card h3 i { color: var(--accent); font-size: 1.2rem; }
        .inventory-container, .grocery-container { flex-grow: 1; overflow-y: auto; margin-bottom: 1.5rem; padding-right: 5px; }
        .inv-category-header { color: var(--primary); font-weight: 700; font-size: 0.75rem; letter-spacing: 1px; text-transform: uppercase; padding: 0.5rem 0; margin-top: 1rem; border-bottom: 1px solid rgba(92, 141, 137, 0.2); margin-bottom: 0.5rem; }
        .inv-category-header:first-child { margin-top: 0; }
        .inventory-item-row, .grocery-item { display: flex; align-items: center; padding: 0.5rem 0.5rem; border-radius: 6px; transition: 0.2s; margin-bottom: 2px; }
        .inventory-item-row:hover, .grocery-item:hover { background: var(--slot-bg); }
        .inventory-item-row input, .grocery-item input { margin-right: 12px; accent-color: var(--primary); width: 16px; height: 16px; cursor: pointer; border-color: #D1D5DB; }
        .inventory-item-row label, .grocery-item label { cursor: pointer; flex-grow: 1; font-size: 0.95rem; color: var(--text-main); font-weight: 400; }
        .delete-item { font-size: 0.8rem; color: #D1D5DB; cursor: pointer; margin-left: 8px; padding: 4px; transition: 0.2s; }
        .delete-item:hover { color: var(--danger); transform: scale(1.1); }
        .grocery-item.manual-item { background-color: var(--slot-bg); border-left: 3px solid var(--text-light); }
        .delete-manual { font-size: 0.8rem; color: #bbb; cursor: pointer; margin-left: 8px;}
        .delete-manual:hover { color: var(--accent); }
        
        .inventory-add-row { display: flex; gap: 0.5rem; align-items: center; }
        button { cursor: pointer; font-family: 'Inter', sans-serif; transition: 0.2s; }
        .inventory-add-row button { background: var(--primary); color: white; border: none; padding: 0 1.2rem; border-radius: 8px; height: 42px; }
        .inventory-add-row button:hover { background: var(--primary-dark); }
        .fab { position: fixed; bottom: 2.5rem; right: 2.5rem; background: var(--primary); color: white; width: 64px; height: 64px; border-radius: 50%; border: none; font-size: 1.5rem; box-shadow: 0 10px 25px rgba(92, 141, 137, 0.4); cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 200; transition: all 0.3s ease; }
        .fab:hover { transform: scale(1.1) rotate(90deg); background: var(--primary-dark); }

        .sub-list { list-style: none; margin-top: 1rem; }
        .sub-list li {
            display: flex; align-items: flex-start; justify-content: space-between;
            padding: 0.8rem 0; border-bottom: 1px solid var(--border);
            color: var(--text-main); font-size: 0.9rem; line-height: 1.4;
        }
        .sub-list li:last-child { border-bottom: none; }
        .sub-original { font-weight: 600; color: var(--primary); width: 35%; flex-shrink: 0; }
        .sub-arrow { color: var(--accent); margin: 0 10px; font-size: 0.85rem; padding-top: 3px; }
        .sub-replacement { color: var(--text-main); flex-grow: 1; }

        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; }
        .tag-pill {
            padding: 6px 12px; border: 1px solid var(--border); border-radius: 20px;
            cursor: pointer; font-size: 0.85rem; transition: 0.2s; color: var(--text-main); background: var(--input-bg);
            display: flex; align-items: center; gap: 6px;
        }
        .tag-pill:hover { background: var(--hover-bg); }
        .tag-pill.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .tag-color-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }

        /* Friend Styles */
        .friend-list { list-style: none; margin-top: 1rem; }
        .friend-item { display: flex; align-items: center; justify-content: space-between; background: var(--card-bg); padding: 1rem; border-radius: 8px; border: var(--border); margin-bottom: 0.5rem; cursor: pointer; transition: 0.2s; }
        .friend-item:hover { transform: translateY(-2px); box-shadow: var(--shadow); border-color: var(--primary); }
        .friend-avatar { width: 32px; height: 32px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 12px; }
        .friend-info { flex-grow: 1; }
        .friend-name { font-weight: 600; color: var(--text-main); }
        .friend-email { font-size: 0.8rem; color: var(--text-light); }

        /* V.53 Toast Styles */
        .toast {
            visibility: hidden; min-width: 250px; margin-left: -125px;
            background-color: var(--primary); color: #fff; text-align: center;
            border-radius: 50px; padding: 16px; position: fixed; z-index: 3000;
            left: 50%; bottom: 30px; font-size: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            opacity: 0; transition: opacity 0.3s, bottom 0.3s; font-weight: 500;
        }
        .toast.show { visibility: visible; opacity: 1; bottom: 50px; }

        /* --- Modals --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(4px); will-change: opacity; }
        .modal-overlay.open { display: flex; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .modal { background: var(--card-bg); padding: 2.5rem; border-radius: 24px; width: 95%; max-width: 550px; box-shadow: 0 25px 50px rgba(0,0,0,0.15); max-height: 85vh; overflow-y: auto; position: relative; border: var(--border); will-change: transform; }

        /* --- Weekly Planned Recipes Modal --- */
        .modal.week-recipes { max-width: 1100px; }
        .week-recipes-summary { color: var(--text-light); font-weight: 600; margin: 0.25rem 0 1.25rem; }
        .week-day-filter { margin: -0.5rem 0 0.75rem; }
        .week-slot-badges { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
        .week-slot-badge { background: var(--slot-bg); border: 1px solid var(--border); color: var(--text-main); padding: 4px 10px; border-radius: 999px; font-size: 0.75rem; font-weight: 700; }
        .recipe-picker-list { list-style: none; margin-top: 1rem; }
        .picker-item { padding: 1rem 1.2rem; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; border-radius: 8px; color: var(--text-main); }
        .picker-item:hover { background: var(--slot-bg); color: var(--primary); padding-left: 1.5rem; }
        .picker-item:last-child { border-bottom: none; }
        
        .modal-header-row { 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;
        }
        
        .modal h2 { margin-bottom: 0; color: var(--primary); font-size: 1.8rem; }
        .modal-close-btn { background: none; border: none; font-size: 1.4rem; cursor: pointer; color: var(--text-light); transition: 0.2s; }
        .modal-close-btn:hover { color: var(--danger); transform: scale(1.1); }
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; margin-bottom: 0.6rem; font-weight: 600; font-size: 0.85rem; text-transform: uppercase; color: var(--text-light); letter-spacing: 0.5px;}
        .modal-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem; }
        button.primary { background: var(--primary); color: white; border: none; padding: 0.8rem 2rem; border-radius: 50px; font-weight: 600; font-size: 1rem; }
        button.primary:hover { background: var(--primary-dark); box-shadow: 0 4px 12px rgba(92, 141, 137, 0.3); }
        button.secondary { background: var(--hover-bg); color: var(--text-main); border: none; padding: 0.8rem 2rem; border-radius: 50px; font-weight: 600; font-size: 1rem; }
        button.secondary:hover { background: var(--border); }
        button.danger { background: var(--danger); color: white; border: none; padding: 0.8rem 2rem; border-radius: 50px; font-weight: 600; font-size: 1rem; }
        button.danger:hover { background: #c0392b; box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        #confirm-modal { z-index: 2100; }
        
        /* Fixed z-index for Alert Modal */
        #alert-modal { z-index: 2200; }

        #auth-modal .modal { max-width: 400px; text-align: center; }
        #auth-error { color: var(--danger); margin-top: 1rem; font-size: 0.9rem; display:none;}
        .auth-toggle { margin-top: 1rem; font-size: 0.9rem; color: var(--text-light); cursor: pointer; text-decoration: underline; }
        .password-wrapper { position: relative; }
        .password-toggle { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--text-light); cursor: pointer; font-size: 1rem; transition: color 0.2s; }
        .password-toggle:hover { color: var(--primary); }

        #cook-mode-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: var(--bg-color); z-index: 2000; display: none; flex-direction: column; overflow-y: auto; will-change: transform; }
        #cook-mode-overlay.active { display: flex; }
        .cook-header { padding: 1.5rem 2rem; background: var(--bg-color); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
        .cook-title { font-size: 1.8rem; margin: 0; color: var(--text-main); }
        .cook-close-btn { background: var(--hover-bg); border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; color: var(--text-main); display: flex; align-items: center; justify-content: center; }
        .cook-body { padding: 2rem; display: grid; grid-template-columns: 1fr 2fr; gap: 3rem; max-width: 1200px; margin: 0 auto; width: 100%; color: var(--text-main); }
        @media(max-width: 768px) { .cook-body { grid-template-columns: 1fr; gap: 2rem; } }
        .cook-section h3 { font-size: 1.4rem; border-bottom: 2px solid var(--primary); padding-bottom: 0.5rem; margin-bottom: 1.5rem; color: var(--primary); }
        .cook-list-item { display: flex; align-items: flex-start; gap: 15px; margin-bottom: 1.2rem; font-size: 1.15rem; line-height: 1.6; cursor: pointer; padding: 0.5rem; border-radius: 8px; transition: 0.2s; color: var(--text-main); }
        .cook-list-item:hover { background: var(--slot-bg); }
        .cook-list-item input { width: 24px; height: 24px; margin-top: 0.20em; accent-color: var(--primary); }
        .cook-list-item.done { text-decoration: line-through; color: var(--text-light); }


        /* --- COOK MODE (V2) - BIG CHECKLIST + STEP TIMERS --- */
        .cook-toggle { 
            display: flex; align-items: flex-start; gap: 14px; 
            cursor: pointer; padding: 0.75rem; border-radius: 12px; transition: 0.2s;
            color: var(--text-main);
        }
        .cook-toggle:hover { background: var(--slot-bg); }
        .cook-toggle input { width: 28px; height: 28px; margin-top: 0.22em; accent-color: var(--primary); flex: 0 0 auto; }
        .cook-item-text { font-size: 1.45rem; line-height: 1.7; }
        .cook-toggle.done { text-decoration: line-through; color: var(--text-light); }

        .cook-step-row { display: flex; align-items: flex-start; justify-content: space-between; gap: 18px; margin-bottom: 1.25rem; }
        .cook-step-main { flex: 1; }
        .cook-step-num {
            width: 34px; height: 34px; border-radius: 12px; background: var(--hover-bg);
            display: flex; align-items: center; justify-content: center; font-weight: 800;
            color: var(--primary); margin-top: 0.22em; flex: 0 0 auto;
        }

        .cook-timer { 
            min-width: 270px; max-width: 340px;
            background: var(--card-bg); border: var(--border); border-radius: 16px;
            padding: 0.85rem 0.9rem; box-shadow: 0 8px 18px rgba(0,0,0,0.06);
            display: flex; flex-direction: column; gap: 0.7rem;
        }
        .cook-timer.running { box-shadow: 0 0 0 3px rgba(92, 141, 137, 0.18), 0 8px 18px rgba(0,0,0,0.06); }
        .cook-timer.finished { box-shadow: 0 0 0 3px rgba(217, 125, 93, 0.25), 0 8px 18px rgba(0,0,0,0.06); }
        .cook-timer-display { 
            font-size: 1.55rem; font-weight: 900; letter-spacing: 1px;
            font-variant-numeric: tabular-nums; color: var(--text-main);
        }
        .cook-timer-controls { display: flex; gap: 8px; }
        .timer-btn {
            flex: 1; border: none; background: var(--hover-bg); color: var(--text-main);
            font-weight: 800; padding: 0.55rem 0.7rem; border-radius: 12px; cursor: pointer;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            font-size: 0.95rem; transition: 0.2s;
        }
        .timer-btn.primary { background: var(--primary); color: #fff; }
        .timer-btn.primary:hover { background: var(--primary-dark); }
        .timer-btn:hover { background: var(--border); }
        .timer-btn:active { transform: translateY(1px); }

        @media(max-width: 768px) {
            .cook-item-text { font-size: 1.25rem; }
            .cook-step-row { flex-direction: column; }
            .cook-timer { min-width: 100%; max-width: 100%; }
            .cook-toggle input { width: 24px; height: 24px; margin-top: 0.20em; }
            .cook-step-num { width: 30px; height: 30px; margin-top: 0.20em; }
        }


        #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--nav-bg); z-index: 3000; justify-content: center; align-items: center; font-size: 2rem; color: var(--primary); }

        /* --- MOBILE RESPONSIVE QUERIES --- */
        @media (max-width: 768px) {
            /* Layout & Nav */
            body { padding-bottom: calc(80px + var(--bottom-nav-height)); } 
            .nav-center, #btn-friends-nav { display: none !important; }
            .mobile-nav-bar { display: flex; }
            .nav-brand { font-size: 1.5rem; }
            
            /* Grids & Cards */
            .recipe-grid { grid-template-columns: 1fr; } 
            .recipe-card { height: auto; min-height: 400px; }
            .tools-section { grid-template-columns: 1fr; }
            
            /* Modals */
            .modal { width: 100%; border-radius: 24px 24px 0 0; position: fixed; bottom: 0; margin: 0; max-width: 100%; max-height: 90vh; }
            .modal-overlay { align-items: flex-end; }
            
            /* Typography */
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
            
            /* FAB moves up */
            .fab { bottom: calc(20px + var(--bottom-nav-height)); }

            /* --- SEARCH BAR RESET FOR MOBILE --- */
            .search-row {
                width: 100%; /* Force full width on small screens */
            }

            /* --- PLANNER MOBILE VIEW V.08 --- */
            .planner-grid { 
                display: block; /* Switch from Flex to Block for stacking */
                padding: 1rem; 
            }
            .planner-labels-column { display: none; } /* Hide the left column labels */
            .day-column { 
                margin-bottom: 2rem; 
                border-bottom: 1px solid var(--border); 
                padding-bottom: 1rem; 
            }
            .day-column:last-child { border-bottom: none; margin-bottom: 0; }
            
            .day-header { text-align: left; font-size: 1.4rem; padding-left: 0.5rem; border-bottom: none; margin-bottom: 0.8rem; }
            
            /* Inject labels via CSS on mobile */
            .meal-slot { 
                height: auto; min-height: 50px; 
                margin-bottom: 8px; 
                flex-direction: row; 
                justify-content: flex-start; 
                padding: 8px 12px;
                text-align: left;
            }
            .meal-slot::before {
                content: attr(data-label); /* Uses attribute to label the slot */
                width: 80px; 
                font-size: 0.75rem; 
                font-weight: 700; 
                text-transform: uppercase; 
                color: var(--text-light);
                letter-spacing: 0.5px;
                flex-shrink: 0;
            }
            .meal-slot[data-type^="dinner"] { height: auto; padding: 8px 12px; }
            .slot-placeholder { font-size: 1rem; margin-left: auto; }
            
            .planned-meal { 
                width: auto; flex-grow: 1; margin-left: 0; 
                height: auto; padding: 8px 12px;
            }
        }
    </style>
</head>
<body>

    <div id="loader"><i class="fas fa-spinner fa-spin"></i></div>
    <div id="toast" class="toast">Action Successful</div>

    <nav>
        <div class="nav-brand"><i class="fas fa-utensils"></i> Stocked</div>
        <div class="nav-center" id="nav-actions" style="display:none;">
            <div class="nav-tabs">
                <button class="active" onclick="switchTab('dashboard')">Dashboard</button>
                <button onclick="switchTab('planning')">Planner</button>
                <button onclick="switchTab('substitutions')">Conversions</button>
            </div>
        </div>
        
        <div class="nav-right" id="user-section" style="display:none;">
            <span class="user-greeting" id="user-greeting"></span>
            
            <button class="nav-icon-btn" id="btn-global-save" onclick="saveAllData()" title="Force Save">
                <i class="fas fa-save"></i>
            </button>

            <button class="nav-icon-btn" id="btn-friends-nav" onclick="switchTab('friends')" title="Friends">
                <i class="fas fa-user-friends"></i>
            </button>

            <div style="position:relative;">
                <button class="nav-icon-btn settings-btn" onclick="toggleSettingsMenu()">
                    <i class="fas fa-cog"></i>
                </button>
                <div id="settings-dropdown" class="settings-dropdown">
                    <div class="settings-item" onclick="openProfileModal()">
                        <i class="fas fa-user"></i> Profile
                    </div>
                    <div class="settings-item" onclick="toggleDarkMode()">
                        <i class="fas fa-moon"></i> Dark Mode
                        <i id="dark-mode-icon" class="fas fa-toggle-off" style="margin-left:auto; color:var(--text-light);"></i>
                    </div>
                    <div class="settings-item danger" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="mobile-nav-bar" id="mobile-nav" style="display:none;">
        <button class="mobile-nav-item active" onclick="switchTab('dashboard')">
            <i class="fas fa-th-large"></i><span>Recipes</span>
        </button>
        <button class="mobile-nav-item" onclick="switchTab('planning')">
            <i class="fas fa-calendar-alt"></i><span>Plan</span>
        </button>
        <button class="mobile-nav-item" onclick="switchTab('friends')">
            <i class="fas fa-user-friends"></i><span>Friends</span>
        </button>
        <button class="mobile-nav-item" onclick="switchTab('substitutions')">
            <i class="fas fa-calculator"></i><span>Tools</span>
        </button>
    </div>

    <div class="container" id="main-content" style="display:none;">
        <section id="dashboard" class="page-section active">
            <br>
            <div class="search-row">
                <i class="fas fa-search"></i>
                <input type="text" id="recipe-search" placeholder="Search recipes by name..." oninput="handleSearch(this.value)">
                <button class="btn-clear-search" id="clear-search-btn" onclick="clearSearch()"><i class="fas fa-times"></i></button>
            </div>
            <div class="filter-row">
                <div class="filter-scroll" id="dashboard-filters"></div>
                <span id="total-recipe-count" class="recipe-count-badge"></span>
                <button class="btn-manage-cats" onclick="openCatManager()"><i class="fas fa-pencil-alt"></i></button>
            </div>
            
            <div id="recipe-grid" class="recipe-grid"></div>
            <button class="fab" onclick="openModal()"><i class="fas fa-plus"></i></button>
        </section>

        <section id="friends" class="page-section">
            <br>
            <div class="header-row">
                <h2>Friends</h2>
                <button class="btn-sm" onclick="openAddFriendModal()"><i class="fas fa-user-plus"></i> Add Friend</button>
            </div>
            <div id="friends-list-container"></div>
        </section>

        <section id="friend-cookbook" class="page-section">
            <br>
            <div class="header-row">
                <h2 id="friend-cookbook-title">Friend's Cookbook</h2>
                <button class="btn-sm" onclick="switchTab('friends')"><i class="fas fa-arrow-left"></i> Back</button>
            </div>
                        <div class="filter-row">
                <div class="filter-scroll" id="friend-cookbook-filters"></div>
                <span id="friend-total-recipe-count" class="recipe-count-badge"></span>
            </div>
            <div id="friend-recipe-grid" class="recipe-grid"></div>
        </section>

        <section id="planning" class="page-section">
            <br>
            <div class="header-row">
                <h2>Weekly Plan</h2>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button class="btn-sm" onclick="openWeekRecipesModal()"><i class="fas fa-layer-group"></i> View Week</button>
                    <button class="btn-sm" onclick="clearWeeklyPlan()"><i class="fas fa-trash-alt"></i> Clear Week</button>
                </div>
            </div>
            
            <div class="planner-grid">
                <div class="planner-labels-column">
                    <div class="day-header" style="border:none;"></div> <div class="meal-row-label"><i class="fas fa-coffee"></i>Break</div>
                    <div class="meal-row-label"><i class="fas fa-hamburger"></i>Lunch</div>
                    <div class="meal-row-label small"><i class="fas fa-drumstick-bite"></i>Dinner</div>
                    <div class="meal-row-label small"><i class="fas fa-bread-slice"></i>Side</div>
                </div>

                <div class="day-column">
                    <div class="day-header">Mon</div>
                    <div class="meal-slot" data-day="0" data-type="break" data-label="Break" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    <div class="meal-slot" data-day="0" data-type="lunch" data-label="Lunch" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    <div class="meal-slot" data-day="0" data-type="dinner-main" data-label="Dinner" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    <div class="meal-slot" data-day="0" data-type="dinner-side" data-label="Side" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                </div>
                <div class="day-column">
                    <div class="day-header">Tue</div>
                    <div class="meal-slot" data-day="1" data-type="break" data-label="Break" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    <div class="meal-slot" data-day="1" data-type="lunch" data-label="Lunch" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    <div class="meal-slot" data-day="1" data-type="dinner-main" data-label="Dinner" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    <div class="meal-slot" data-day="1" data-type="dinner-side" data-label="Side" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                </div>
                <div class="day-column">
                    <div class="day-header">Wed</div>
                    <div class="meal-slot" data-day="2" data-type="break" data-label="Break" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    <div class="meal-slot" data-day="2" data-type="lunch" data-label="Lunch" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    <div class="meal-slot" data-day="2" data-type="dinner-main" data-label="Dinner" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    <div class="meal-slot" data-day="2" data-type="dinner-side" data-label="Side" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                </div>
                <div class="day-column">
                    <div class="day-header">Thu</div>
                    <div class="meal-slot" data-day="3" data-type="break" data-label="Break" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    <div class="meal-slot" data-day="3" data-type="lunch" data-label="Lunch" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    <div class="meal-slot" data-day="3" data-type="dinner-main" data-label="Dinner" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    <div class="meal-slot" data-day="3" data-type="dinner-side" data-label="Side" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                </div>
                <div class="day-column">
                    <div class="day-header">Fri</div>
                    <div class="meal-slot" data-day="4" data-type="break" data-label="Break" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    <div class="meal-slot" data-day="4" data-type="lunch" data-label="Lunch" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    <div class="meal-slot" data-day="4" data-type="dinner-main" data-label="Dinner" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    <div class="meal-slot" data-day="4" data-type="dinner-side" data-label="Side" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                </div>
                <div class="day-column">
                    <div class="day-header">Sat</div>
                    <div class="meal-slot" data-day="5" data-type="break" data-label="Break" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    <div class="meal-slot" data-day="5" data-type="lunch" data-label="Lunch" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    <div class="meal-slot" data-day="5" data-type="dinner-main" data-label="Dinner" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    <div class="meal-slot" data-day="5" data-type="dinner-side" data-label="Side" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                </div>
                <div class="day-column">
                    <div class="day-header">Sun</div>
                    <div class="meal-slot" data-day="6" data-type="break" data-label="Break" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    <div class="meal-slot" data-day="6" data-type="lunch" data-label="Lunch" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    <div class="meal-slot" data-day="6" data-type="dinner-main" data-label="Dinner" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    <div class="meal-slot" data-day="6" data-type="dinner-side" data-label="Side" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                </div>
            </div>

            <div class="tools-section">
                <div class="tool-card">
                    <div class="header-row"><h3><i class="fas fa-carrot"></i> Ingredients on Hand</h3><button class="btn-sm" id="btn-clear-inventory" onclick="clearInventoryConfirm()"><i class="fas fa-trash"></i> Clear</button></div>
                    <div id="inventory-list-container" class="inventory-container"></div>
                    <div class="inventory-add-row">
                        <div class="custom-select-container" id="inv-cat-select">
                            <select id="new-item-category">
                                <option value="Produce">Produce</option><option value="Meat & Protein">Meat & Protein</option><option value="Dairy & Fridge">Dairy & Fridge</option><option value="Pantry & Grains">Pantry & Grains</option><option value="Spices & Seasonings">Spices</option>
                            </select>
                        </div>
                        <input type="text" id="new-inventory-item" placeholder="Add item...">
                        <button onclick="addInventoryItem()"><i class="fas fa-plus"></i></button>
                    </div>
                </div>

                <div class="tool-card">
                    <div class="header-row">
                        <h3><i class="fas fa-shopping-basket"></i> Grocery List</h3>
                        <button class="btn-sm" id="btn-copy-list" onclick="copyGroceryList()"><i class="far fa-copy"></i> Copy</button>
                    </div>
                    <div id="grocery-list-output" class="grocery-container"></div>
                    <div class="inventory-add-row" style="border-top: 1px dashed var(--border); padding-top: 1.5rem;">
                        <div class="custom-select-container" id="groc-cat-select">
                            <select id="manual-grocery-category">
                                <option value="Produce">Produce</option><option value="Meat & Protein">Meat & Protein</option><option value="Dairy & Fridge">Dairy & Fridge</option><option value="Pantry & Grains">Pantry & Grains</option><option value="Spices & Seasonings">Spices</option><option value="Other">Other</option>
                            </select>
                        </div>
                        <input type="text" id="manual-grocery-item" placeholder="Add extra item...">
                        <button onclick="addManualGroceryItem()"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </div>
        </section>

        <section id="substitutions" class="page-section">
            <br>
            <div class="header-row">
                <h2>Conversions & Substitutions</h2>
            </div>
            <div class="tools-section">
                <div class="tool-card">
                    <h3><i class="fas fa-calculator"></i> Common Conversions</h3>
                    <ul class="sub-list">
                        <li><span class="sub-original">3 teaspoons</span><i class="fas fa-arrow-right sub-arrow"></i><span class="sub-replacement">1 tablespoon</span></li>
                        <li><span class="sub-original">4 tablespoons</span><i class="fas fa-arrow-right sub-arrow"></i><span class="sub-replacement">1/4 cup</span></li>
                        <li><span class="sub-original">16 tablespoons</span><i class="fas fa-arrow-right sub-arrow"></i><span class="sub-replacement">1 cup</span></li>
                        <li><span class="sub-original">1 cup</span><i class="fas fa-arrow-right sub-arrow"></i><span class="sub-replacement">8 fluid ounces</span></li>
                        <li><span class="sub-original">1 pint</span><i class="fas fa-arrow-right sub-arrow"></i><span class="sub-replacement">2 cups</span></li>
                        <li><span class="sub-original">1 quart</span><i class="fas fa-arrow-right sub-arrow"></i><span class="sub-replacement">2 pints</span></li>
                        <li><span class="sub-original">1 gallon</span><i class="fas fa-arrow-right sub-arrow"></i><span class="sub-replacement">4 quarts</span></li>
                    </ul>
                </div>
                <div class="tool-card">
                    <h3><i class="fas fa-cookie-bite"></i> Baking & Pantry</h3>
                    <ul class="sub-list">
                        <li><span class="sub-original">1 tsp Baking Powder</span><i class="fas fa-arrow-right sub-arrow"></i><span class="sub-replacement">1/4 tsp Baking Soda + 1/2 tsp Cream of Tartar</span></li>
                        <li><span class="sub-original">1 oz Chocolate</span><i class="fas fa-arrow-right sub-arrow"></i><span class="sub-replacement">3 tbsp Cocoa + 1 tbsp Shortening</span></li>
                        <li><span class="sub-original">1 tbsp Corn Starch</span><i class="fas fa-arrow-right sub-arrow"></i><span class="sub-replacement">2 tbsp Flour</span></li>
                        <li><span class="sub-original">1 cup Cake Flour</span><i class="fas fa-arrow-right sub-arrow"></i><span class="sub-replacement">7/8 cup All Purpose + 2 tbsp Cornstarch</span></li>
                        <li><span class="sub-original">1 cup Brown Sugar</span><i class="fas fa-arrow-right sub-arrow"></i><span class="sub-replacement">3/4 cup White Sugar + 1/4 cup Molasses</span></li>
                        <li><span class="sub-original">1 cup Powdered Sugar</span><i class="fas fa-arrow-right sub-arrow"></i><span class="sub-replacement">1 cup White Sugar (blended)</span></li>
                    </ul>
                </div>
                <div class="tool-card">
                    <h3><i class="fas fa-cheese"></i> Dairy & Fridge</h3>
                    <ul class="sub-list">
                        <li><span class="sub-original">1 cup Butter</span><i class="fas fa-arrow-right sub-arrow"></i><span class="sub-replacement">1 cup Margarine</span></li>
                        <li><span class="sub-original">1 cup Buttermilk</span><i class="fas fa-arrow-right sub-arrow"></i><span class="sub-replacement">1 tbsp Vinegar + Milk (to 1 cup)</span></li>
                        <li><span class="sub-original">1 cup Cream</span><i class="fas fa-arrow-right sub-arrow"></i><span class="sub-replacement">1/2 cup Butter + 3/4 cup Milk</span></li>
                        <li><span class="sub-original">1 Whole Egg</span><i class="fas fa-arrow-right sub-arrow"></i><span class="sub-replacement">2 Egg Yolks</span></li>
                        <li><span class="sub-original">1 cup Sour Cream</span><i class="fas fa-arrow-right sub-arrow"></i><span class="sub-replacement">1 cup Yogurt</span></li>
                    </ul>
                </div>
                <div class="tool-card">
                    <h3><i class="fas fa-pepper-hot"></i> Savory & Misc</h3>
                    <ul class="sub-list">
                        <li><span class="sub-original">1 clove Garlic</span><i class="fas fa-arrow-right sub-arrow"></i><span class="sub-replacement">1/8 tsp Garlic Powder</span></li>
                        <li><span class="sub-original">1 tbsp Fresh Herbs</span><i class="fas fa-arrow-right sub-arrow"></i><span class="sub-replacement">1 tsp Dried</span></li>
                        <li><span class="sub-original">1 tbsp Mustard</span><i class="fas fa-arrow-right sub-arrow"></i><span class="sub-replacement">1 tsp Dry Mustard</span></li>
                        <li><span class="sub-original">1 Onion</span><i class="fas fa-arrow-right sub-arrow"></i><span class="sub-replacement">1 tbsp Onion Powder</span></li>
                        <li><span class="sub-original">1/2 cup Wine</span><i class="fas fa-arrow-right sub-arrow"></i><span class="sub-replacement">1/4 cup Vinegar + 1 tbsp Sugar + Water</span></li>
                    </ul>
                </div>
            </div>
        </section>
    </div>

    <div id="add-friend-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header-row">
                <h2>Add Friend</h2>
                <button class="modal-close-btn" onclick="closeAddFriendModal()"><i class="fas fa-times"></i></button>
            </div>
            <p style="color:var(--text-light); margin-bottom:1rem; font-size:0.9rem;">Enter your friend's email address to add them. They must have saved their profile at least once.</p>
            <div class="inventory-add-row" style="margin-bottom: 1rem;">
                <input type="email" id="friend-email-input" placeholder="friend@example.com">
                <button onclick="addFriend()"><i class="fas fa-user-plus"></i></button>
            </div>
            <div id="add-friend-msg"></div>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal" style="max-width: 400px; text-align: center;">
            <h2 class="confirm-title" style="margin-bottom: 1rem; color: var(--danger);">Are you sure?</h2>
            <p id="confirm-message" style="color: var(--text-light); margin-bottom: 2rem; font-size: 1rem;"></p>
            <div class="modal-actions" style="justify-content: center; gap: 1rem; margin-top: 0;">
                <button class="secondary" onclick="closeConfirmModal()">Cancel</button>
                <button id="confirm-yes-btn" class="danger">Yes, I'm sure</button>
            </div>
        </div>
    </div>

    <div id="alert-modal" class="modal-overlay">
        <div class="modal" style="max-width: 400px; text-align: center;">
            <div style="margin-bottom: 1rem; font-size: 3rem; color: var(--accent);"><i id="alert-icon-i" class="fas fa-exclamation-circle"></i></div>
            <h2 id="alert-title" class="confirm-title" style="margin-bottom: 1rem; color: var(--text-main);">Missing Details</h2>
            <p id="alert-message" style="color: var(--text-light); margin-bottom: 2rem; font-size: 1rem;"></p>
            <div class="modal-actions" style="justify-content: center; margin-top: 0;">
                <button class="primary" onclick="closeAlertModal()">Got it</button>
            </div>
        </div>
    </div>

    <div id="auth-modal" class="modal-overlay open">
        <div class="modal">
            <h2 id="auth-title" class="auth-title">Welcome to Stocked</h2>
            <p style="color:var(--text-light); margin-bottom:1.5rem;">Login to save your recipes and plans.</p>
            <div id="auth-error"></div>
            <div id="auth-name-container" style="display:none; gap:10px; margin-bottom:1.2rem;">
                 <div style="flex:1;">
                     <label style="display:block; margin-bottom:0.6rem; font-weight:600; font-size:0.85rem; text-transform:uppercase; color:var(--text-light); letter-spacing:0.5px;">First Name</label>
                     <input type="text" id="auth-first" placeholder="Jane" style="width:100%;">
                 </div>
                 <div style="flex:1;">
                     <label style="display:block; margin-bottom:0.6rem; font-weight:600; font-size:0.85rem; text-transform:uppercase; color:var(--text-light); letter-spacing:0.5px;">Last Name</label>
                     <input type="text" id="auth-last" placeholder="Doe" style="width:100%;">
                 </div>
            </div>

            <div class="form-group">
                <label>Email</label>
                <input type="email" id="auth-email" placeholder="you@example.com">
            </div>
            <div class="form-group">
                <label>Password</label>
                <div class="password-wrapper">
                    <input type="password" id="auth-password" placeholder="">
                    <i class="fas fa-eye password-toggle" onclick="togglePasswordVisibility()"></i>
                </div>
            </div>
            <button class="primary" style="width:100%; margin-top:1rem;" onclick="handleAuth()">Log In</button>
            <div class="auth-toggle" onclick="toggleAuthMode()">Don't have an account? Sign Up</div>
        </div>
    </div>

    <div id="profile-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header-row">
                <h2>Your Profile</h2>
                <button class="modal-close-btn" onclick="closeProfileModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="form-group">
                <label>First Name</label>
                <input type="text" id="profile-first" placeholder="e.g. Braden">
            </div>
            <div class="form-group">
                <label>Last Name</label>
                <input type="text" id="profile-last" placeholder="e.g. Smith">
            </div>
            <div class="modal-actions">
                <button class="primary" onclick="saveProfile()">Save & Make Discoverable</button>
            </div>
        </div>
    </div>

    <div id="cat-manager-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header-row">
                <h2>Manage Categories</h2>
                <button class="modal-close-btn" onclick="closeCatManager()"><i class="fas fa-times"></i></button>
            </div>
            <div style="margin-bottom: 1rem;">
                <label style="display:block; margin-bottom:0.5rem; font-weight:600; font-size:0.85rem; text-transform:uppercase; color:var(--text-light);">New Category</label>
                <div id="color-picker-container" class="color-picker-row"></div>
            </div>
            <div class="inventory-add-row" style="margin-bottom: 1rem;">
                <input type="text" id="new-cat-name" placeholder="Category Name (e.g. Thai)">
                <button onclick="addNewCategory()"><i class="fas fa-plus"></i></button>
            </div>
            <hr style="border:0; border-top:1px solid var(--border); margin:1.5rem 0;">
            <p style="font-size:0.85rem; color:var(--text-light); margin-bottom:0.5rem;">Current Categories (Click color to edit)</p>
            <ul id="manage-cat-list" class="cat-list">
            </ul>
            <div class="modal-actions">
                <button class="primary" onclick="closeCatManager()">Done</button>
            </div>
        </div>
        <div id="edit-color-popup" style="display:none; position:absolute; background:var(--card-bg); padding:10px; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.2); border:1px solid var(--border); z-index:1100; display:flex; gap:5px; flex-wrap:wrap; width:160px;">
        </div>
    </div>

    <div id="recipe-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header-row">
                <h2 id="modal-title">Add Recipe</h2>
                <button class="modal-close-btn" onclick="closeModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="import-row">
                <div style="flex-grow:1;">
                    <input type="url" id="import-url" placeholder="Paste recipe URL here..." style="width:100%; border:1px solid #ccc;">
                </div>
                <button class="btn-import" onclick="importRecipe()"><i class="fas fa-magic"></i> Auto-Fill</button>
            </div>
            <div class="form-group">
                <label>Title</label>
                <div class="input-wrapper">
                    <input type="text" id="inp-title" placeholder="e.g. Grandma's Lasagna">
                    <button class="mic-btn" onclick="toggleDictation('inp-title', this)"><i class="fas fa-microphone"></i></button>
                </div>
            </div>
            
            <div class="form-group">
                <label>Cuisine Style (Select multiple)</label>
                <div id="category-tag-container" class="tag-container">
                    </div>
            </div>

            <div class="form-group">
                <label>Ingredients (one per line)</label>
                <div class="input-wrapper">
                    <textarea id="inp-ingredients" rows="4" placeholder="2 Eggs&#10;1 cup Flour"></textarea>
                    <button class="mic-btn" onclick="toggleDictation('inp-ingredients', this)"><i class="fas fa-microphone"></i></button>
                </div>
            </div>
            <div class="form-group">
                <label>Instructions</label>
                <div class="input-wrapper">
                    <textarea id="inp-instructions" rows="6" placeholder="1. Mix ingredients...&#10;2. Bake at 350..."></textarea>
                    <button class="mic-btn" onclick="toggleDictation('inp-instructions', this)"><i class="fas fa-microphone"></i></button>
                </div>
            </div>
            <input type="hidden" id="inp-id">
            <div class="modal-actions">
                <button class="secondary" onclick="closeModal()">Cancel</button>
                <button class="primary" onclick="saveRecipe()">Save Recipe</button>
            </div>
        </div>
    </div>

    <div id="selector-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header-row">
                <h2>Select a Meal</h2>
                <button class="modal-close-btn" onclick="closeSelectorModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="filter-scroll" id="picker-filters"></div>
            <ul id="picker-list" class="recipe-picker-list"></ul>
            <div class="modal-actions">
                <button class="secondary" onclick="closeSelectorModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="week-recipes-modal" class="modal-overlay">
        <div class="modal week-recipes">
            <div class="modal-header-row">
                <h2>This Week's Recipes</h2>
                <button class="modal-close-btn" onclick="closeWeekRecipesModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="week-day-filter">
                <div class="filter-scroll" id="week-day-filters"></div>
            </div>
            <div id="week-recipes-summary" class="week-recipes-summary"></div>
            <div id="week-recipes-grid" class="recipe-grid"></div>
            <div class="modal-actions">
                <button class="secondary" onclick="closeWeekRecipesModal()">Close</button>
            </div>
        </div>
    </div>

    <div id="cook-mode-overlay">
        <div class="cook-header">
            <h2 id="cook-title" class="cook-title">Recipe Title</h2>
            <button class="cook-close-btn" onclick="closeCookMode()"><i class="fas fa-times"></i></button>
        </div>
        <div class="cook-body">
            <div class="cook-section"><h3>Ingredients</h3><div id="cook-ingredients"></div></div>
            <div class="cook-section"><h3>Instructions</h3><div id="cook-instructions"></div></div>
        </div>
    </div>

    <div id="view-recipe-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header-row" style="align-items: flex-start;">
                <div style="flex-grow:1;">
                    <div id="view-modal-badges" class="cat-badges" style="margin-bottom:8px;"></div>
                    <h2 id="view-modal-title" class="recipe-title" style="font-size:1.8rem; color:var(--text-main);">Recipe Title</h2>
                </div>
                <button class="modal-close-btn" onclick="closeViewModal()"><i class="fas fa-times"></i></button>
            </div>
            
            <div style="display:flex; gap:10px; margin-bottom:1.5rem; border-bottom:1px solid var(--border); padding-bottom:1rem;">
                <button id="view-btn-cook" class="btn-cook" style="flex:1; justify-content:center;"><i class="fas fa-fire"></i> Start Cooking</button>
                <button id="view-btn-edit" class="btn-sm"><i class="fas fa-edit"></i> Edit</button>
                <button id="view-btn-copy" class="btn-sm"><i class="far fa-copy"></i> Copy Text</button>
                <button id="view-btn-print" class="btn-sm" onclick="printRecipe()"><i class="fas fa-print"></i> Print</button>
            </div>

            <div class="form-group">
                <label>Ingredients</label>
                <ul id="view-ingredients" style="margin-left:1.5rem; line-height:1.6; color:var(--text-main);"></ul>
            </div>
            <div class="form-group">
                <label>Instructions</label>
                <div id="view-instructions" style="line-height:1.7; color:var(--text-main);"></div>
            </div>
        </div>
    </div>

    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, updateDoc, deleteDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // =====================================================================
        // 1) FIREBASE CONFIGURATION (Auth + Firestore)
        // =====================================================================
        const firebaseConfig = {
          apiKey: "AIzaSyB5tfvrxjwVVp3fdWDP1p_EiqLpQc-yxT8",
          authDomain: "stocked-website.firebaseapp.com",
          projectId: "stocked-website",
          storageBucket: "stocked-website.firebasestorage.app",
          messagingSenderId: "532018821574",
          appId: "1:532018821574:web:2dd176a57164e0a8a3dac7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);


        // =====================================================================
        // 2) GLOBAL APPLICATION STATE
        //    (Kept in-memory; persisted to Firestore / localStorage where needed)
        // =====================================================================
        let currentUser = null;
        let isSignup = false; 
        
        let recipes = [];
        let friendRecipes = []; 
        let mealPlan = {};
        let inventory = [];
        let manualGrocery = [];
        let friends = []; 
        
                let friendCategories = []; 
const PRESET_COLORS = [
            '#E74C3C', '#E67E22', '#F1C40F', '#2ECC71', '#1ABC9C', 
            '#3498DB', '#9B59B6', '#E91E63', '#34495E', '#A2D729'
        ];
        let selectedColor = PRESET_COLORS[0];

        let appCategories = [
            { name: "Italian", color: "#E74C3C" }, 
            { name: "Mexican", color: "#2ECC71" }, 
            { name: "Asian", color: "#E67E22" },    
            { name: "American", color: "#3498DB" },
            { name: "Healthy", color: "#A2D729" }, 
            { name: "Breakfast", color: "#F1C40F"},
            { name: "Dessert", color: "#E91E63" }, 
            { name: "Other", color: "#34495E" }     
        ];
        let userProfile = { firstName: '', lastName: '' };
        let isDarkMode = false;

        const INVENTORY_CATEGORIES = ["Produce", "Meat & Protein", "Dairy & Fridge", "Pantry & Grains", "Spices & Seasonings", "Other"];
        const CATEGORY_KEYWORDS = {
            "Produce": ["onion", "garlic", "lemon", "lime", "tomato", "potato", "carrot", "lettuce", "spinach", "pepper", "fruit", "veg", "avocado", "banana", "herb", "cilantro", "parsley", "basil", "chive"],
            "Meat & Protein": ["chicken", "beef", "pork", "steak", "fish", "salmon", "tuna", "shrimp", "tofu", "meat", "bacon", "sausage", "turkey", "ham"],
            "Dairy & Fridge": ["milk", "cheese", "butter", "egg", "cream", "yogurt", "cheddar", "mozzarella", "parmesan"],
            "Pantry & Grains": ["rice", "pasta", "noodle", "bread", "flour", "sugar", "cereal", "oat", "can", "bean", "lentil", "sauce", "jar", "honey", "nut"],
            "Spices & Seasonings": ["salt", "pepper", "oil", "vinegar", "spice", "paprika", "cumin", "soy", "seasoning"]
        };

        let currentDashboardFilter = "All";
        let currentFriendFilter = "All";
        let currentPickerFilter = "All";
        let currentSearchQuery = "";
        let searchTimeout = null;
        let activeSlot = { day: null, type: null };
        let wakeLock = null;
        let confirmCallback = null;

        // =====================================================================
        // 3) UI UTILITIES (toasts, modals, formatting helpers)
        // =====================================================================
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.innerText = message;
            toast.className = 'toast show';
            setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 3000);
        }

        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); }
            const h = Math.abs(hash % 360);
            return `hsl(${h}, 65%, 60%)`; 
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                isDarkMode = true;
                document.body.setAttribute('data-theme', 'dark');
            }
            updateDarkModeIcon();
        }

        window.toggleDarkMode = () => {
            isDarkMode = !isDarkMode;
            if (isDarkMode) {
                document.body.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
            }
            updateDarkModeIcon();
        };

        function updateDarkModeIcon() {
            const icon = document.getElementById('dark-mode-icon');
            if (isDarkMode) {
                icon.className = 'fas fa-toggle-on';
                icon.style.color = 'var(--primary)';
            } else {
                icon.className = 'fas fa-toggle-off';
                icon.style.color = 'var(--text-light)';
            }
        }

        initTheme();

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-modal').classList.remove('open');
                document.getElementById('main-content').style.display = 'block';
                if(window.innerWidth > 768) {
                    document.getElementById('nav-actions').style.display = 'flex';
                }
                if(window.innerWidth <= 768) {
                    document.getElementById('mobile-nav').style.display = 'flex';
                }
                document.getElementById('user-section').style.display = 'flex'; 
                await loadUserData();
                initCustomSelects();
                initColorPicker();
            } else {
                currentUser = null;
                document.getElementById('auth-modal').classList.add('open');
                document.getElementById('main-content').style.display = 'none';
                document.getElementById('nav-actions').style.display = 'none';
                document.getElementById('user-section').style.display = 'none';
                document.getElementById('mobile-nav').style.display = 'none';
            }
        });

        // --- Voice Dictation ---
        let recognition = null;
        let activeInputId = null;
        let activeMicBtn = null;

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false; 
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = function() {
                if(activeMicBtn) activeMicBtn.classList.add('listening');
            };

            recognition.onend = function() {
                if(activeMicBtn) activeMicBtn.classList.remove('listening');
                activeInputId = null;
                activeMicBtn = null;
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                if(activeInputId) {
                    const input = document.getElementById(activeInputId);
                    if(input.value.length > 0) input.value += ' ' + transcript;
                    else input.value = transcript;
                }
            };
        }

        window.toggleDictation = (inputId, btnElement) => {
            if (!recognition) {
                alert("Your browser does not support speech recognition. Please use Chrome or Safari.");
                return;
            }
            if (activeInputId === inputId) {
                recognition.stop(); 
            } else {
                activeInputId = inputId;
                activeMicBtn = btnElement;
                recognition.start();
            }
        };

        function initColorPicker() {
            const container = document.getElementById('color-picker-container');
            container.innerHTML = '';
            PRESET_COLORS.forEach((color, idx) => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = color;
                if(idx === 0) swatch.classList.add('selected'); // Select first by default
                swatch.onclick = () => {
                    document.querySelectorAll('#color-picker-container .color-swatch').forEach(s => s.classList.remove('selected'));
                    swatch.classList.add('selected');
                    selectedColor = color;
                };
                container.appendChild(swatch);
            });
        }

        window.toggleSettingsMenu = () => {
            const menu = document.getElementById('settings-dropdown');
            menu.classList.toggle('show');
        };
        
        window.addEventListener('click', function(e) {
            if (!e.target.closest('.settings-btn') && !e.target.closest('.settings-dropdown')) {
                document.getElementById('settings-dropdown').classList.remove('show');
            }
            // Close edit color popup
            if (!e.target.closest('.cat-color-dot') && !e.target.closest('#edit-color-popup')) {
                document.getElementById('edit-color-popup').style.display = 'none';
            }
        });

        window.openProfileModal = () => {
            document.getElementById('profile-first').value = userProfile.firstName || '';
            document.getElementById('profile-last').value = userProfile.lastName || '';
            document.getElementById('profile-modal').classList.add('open');
            document.getElementById('settings-dropdown').classList.remove('show');
        };
        window.closeProfileModal = () => document.getElementById('profile-modal').classList.remove('open');

        window.saveProfile = async () => {
            const first = document.getElementById('profile-first').value.trim();
            const last = document.getElementById('profile-last').value.trim();
            userProfile = { firstName: first, lastName: last };
            
            document.getElementById('loader').style.display = 'flex';
            await setDoc(doc(db, "users", currentUser.uid, "data", "profile"), userProfile);
            
            // Create Public Profile for Friend Finding
            const safeEmail = currentUser.email.replace(/\./g, ',');
            await setDoc(doc(db, "public_profiles", safeEmail), {
                uid: currentUser.uid,
                firstName: first,
                lastName: last,
                email: currentUser.email
            });

            document.getElementById('loader').style.display = 'none';
            renderGreeting();
            closeProfileModal();
        };

        function renderGreeting() {
            const el = document.getElementById('user-greeting');
            if (userProfile.firstName) {
                el.innerText = `Hello ${userProfile.firstName}!`;
                el.style.display = 'block';
            } else {
                el.style.display = 'none';
            }
        }

        // --- V.54 Logic: Recipe Multiplier (Restored) ---
        window.updateMultiplier = (el, change) => {
            const badge = el.closest('.multiplier-badge');
            const valSpan = badge.querySelector('.mult-val');
            let current = parseFloat(valSpan.innerText);
            
            let newVal = current + change;
            if(newVal < 0.5) newVal = 0.5; 
            if(newVal > 10) newVal = 10;      
            
            valSpan.innerText = newVal + 'x';
            
            const card = el.closest('.recipe-card');
            const list = card.querySelector('.ingredient-list');
            const originalText = decodeURIComponent(list.dataset.original);
            
            list.innerHTML = formatScaledIngredients(originalText, newVal);
            
            const rId = card.dataset.id;
            const rIndex = recipes.findIndex(r => r.id == rId);
            if(rIndex > -1) {
                recipes[rIndex].currentMultiplier = newVal;
            }
        };

        function safeParseFraction(str) {
            if(!str.includes('/')) return parseFloat(str);
            const [num, den] = str.split('/').map(Number);
            return den ? num / den : 0;
        }

        function formatScaledIngredients(text, multiplier) {
            if (!text) return '';
            const lines = text.split('\n');
            return lines.map(line => {
                if(!line.trim()) return '';
                // Simple regex to catch numbers and scale them
                const scaledLine = line.replace(/^(\d+(?:\.\d+)?(?:\s+\d+\/\d+)?|\d+\/\d+)/, (match) => {
                    let num = 0;
                    if(match.includes(' ')) { 
                        const parts = match.split(' ');
                        num = parseFloat(parts[0]) + safeParseFraction(parts[1]);
                    } else if(match.includes('/')) { 
                        num = safeParseFraction(match);
                    } else { 
                        num = parseFloat(match);
                    }
                    
                    let result = num * multiplier;
                    
                    // Format nice string
                    if(Math.abs(result - Math.round(result)) < 0.05) return Math.round(result);
                    return parseFloat(result.toFixed(2));
                });
                
                return `<li>${scaledLine}</li>`;
            }).join('');
        }
        
        // --- NEW HELPER: FORMAT INSTRUCTIONS AS NUMBERED LIST ---
        function formatInstructionsHTML(text) {
            if (!text) return '';
            const steps = text.split('\n').filter(line => line.trim() !== '');
            if (steps.length === 0) return '';
            return `<ol style="margin-left: 20px; padding-left: 0;">${steps.map(step => `<li style="margin-bottom: 5px;">${step}</li>`).join('')}</ol>`;
        }

        /* --- NEW IMPORT FROM URL LOGIC --- */
        window.importRecipe = async () => {
            const urlInput = document.getElementById('import-url');
            const url = urlInput.value.trim();
            if(!url) return showToast("Please enter a valid URL");

            const btn = document.querySelector('.btn-import');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Fetching...`;
            
            try {
                // Use AllOrigins proxy with timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 second timeout
                
                const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                if (!data.contents) throw new Error("No data returned");

                const parser = new DOMParser();
                const doc = parser.parseFromString(data.contents, 'text/html');
                
                // Find JSON-LD script
                const scripts = doc.querySelectorAll('script[type="application/ld+json"]');
                let foundRecipe = null;

                for (const script of scripts) {
                    try {
                        const json = JSON.parse(script.innerText);
                        const items = Array.isArray(json['@graph']) ? json['@graph'] : (Array.isArray(json) ? json : [json]);
                        
                        foundRecipe = items.find(item => item['@type'] === 'Recipe' || (Array.isArray(item['@type']) && item['@type'].includes('Recipe')));
                        if(foundRecipe) break;
                    } catch(e) { console.error(e); }
                }

                if(foundRecipe) {
                    document.getElementById('inp-title').value = foundRecipe.name || '';
                    
                    if(foundRecipe.recipeIngredient) {
                        const ings = Array.isArray(foundRecipe.recipeIngredient) ? foundRecipe.recipeIngredient.join('\n') : foundRecipe.recipeIngredient;
                        document.getElementById('inp-ingredients').value = ings;
                    }

                    if(foundRecipe.recipeInstructions) {
                        let instText = '';
                        if(Array.isArray(foundRecipe.recipeInstructions)) {
                            instText = foundRecipe.recipeInstructions.map(step => {
                                if(typeof step === 'object') return step.text || step.name || '';
                                return step;
                            }).join('\n');
                        } else {
                            instText = foundRecipe.recipeInstructions;
                        }
                        document.getElementById('inp-instructions').value = instText;
                    }
                    
                    showToast("Recipe imported successfully!");
                    urlInput.value = ''; 
                } else {
                    openAlertModal("Unable to extract recipe details. Please add manually");
                }

            } catch(e) {
                console.error(e);
                openAlertModal("Unable to access this link. Please add details manually.");
            } finally {
                btn.innerHTML = originalText;
            }
        };

        // --- PRINT RECIPE FUNCTION ---
        window.printRecipe = () => {
            const title = document.getElementById('view-modal-title').innerText;
            const ingredients = document.getElementById('view-ingredients').innerText;
            
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>' + title + '</title>');
            printWindow.document.write('<style>');
            printWindow.document.write('body { font-family: sans-serif; padding: 2rem; color: #333; line-height: 1.6; }');
            printWindow.document.write('h1 { font-family: serif; border-bottom: 2px solid #5C8D89; padding-bottom: 10px; margin-bottom: 20px; }');
            printWindow.document.write('h2 { font-size: 1.2rem; text-transform: uppercase; color: #5C8D89; margin-top: 30px; letter-spacing: 1px; }');
            printWindow.document.write('ul { list-style: none; padding: 0; }');
            printWindow.document.write('li { margin-bottom: 8px; display: flex; align-items: flex-start; gap: 10px; }');
            printWindow.document.write('.checkbox { width: 16px; height: 16px; border: 1px solid #ccc; display: inline-block; flex-shrink: 0; margin-top: 4px; }');
            printWindow.document.write('</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<h1>' + title + '</h1>');
            
            printWindow.document.write('<h2>Ingredients</h2>');
            printWindow.document.write('<ul>');
            const ingLines = ingredients.split('\n').filter(l => l.trim());
            ingLines.forEach(line => {
                printWindow.document.write('<li><span class="checkbox"></span> ' + line + '</li>');
            });
            printWindow.document.write('</ul>');

            printWindow.document.write('<h2>Instructions</h2>');
            const instHTML = document.getElementById('view-instructions').innerHTML;
            printWindow.document.write('<div>' + instHTML + '</div>');

            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
        };

        window.openAlertModal = (message, title = 'Missing Details', iconClass = 'fa-exclamation-circle') => {
            const titleEl = document.getElementById('alert-title');
            if (titleEl) titleEl.innerText = title;
            const iconEl = document.getElementById('alert-icon-i');
            if (iconEl) iconEl.className = `fas ${iconClass}`;
            document.getElementById('alert-message').innerText = message;
            document.getElementById('alert-modal').classList.add('open');
        };
        window.closeAlertModal = () => document.getElementById('alert-modal').classList.remove('open');

        window.openAddFriendModal = () => {
            document.getElementById('add-friend-modal').classList.add('open');
            document.getElementById('add-friend-msg').innerText = '';
            document.getElementById('friend-email-input').value = '';
        };
        window.closeAddFriendModal = () => document.getElementById('add-friend-modal').classList.remove('open');

        window.addFriend = async () => {
            const email = document.getElementById('friend-email-input').value.trim().toLowerCase();
            const msg = document.getElementById('add-friend-msg');
            if(!email) return;
            if(email === currentUser.email) { msg.innerText = "You can't add yourself!"; return; }

            document.getElementById('loader').style.display = 'flex';
            const safeEmail = email.replace(/\./g, ',');
            
            try {
                const docSnap = await getDoc(doc(db, "public_profiles", safeEmail));
                if (docSnap.exists()) {
                    const friendData = docSnap.data();
                    if(friends.some(f => f.uid === friendData.uid)) {
                        msg.innerText = "Already in your friends list.";
                    } else {
                        friends.push(friendData);
                        await setDoc(doc(db, "users", currentUser.uid, "data", "friends"), { list: friends });
                        renderFriendsList();
                        closeAddFriendModal();
                    }
                } else {
                    msg.innerHTML = `<span style="color:var(--danger)">User not found.</span><br>Ask them to update their profile to be discoverable.`;
                }
            } catch (error) {
                console.error(error);
                msg.innerText = "Error searching. Check your connection.";
            }
            document.getElementById('loader').style.display = 'none';
        };

        function renderFriendsList() {
            const container = document.getElementById('friends-list-container');
            container.innerHTML = '';
            if(friends.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:2rem; color:var(--text-light)">No friends added yet.</div>';
                return;
            }
            friends.forEach(f => {
                const initial = f.firstName ? f.firstName.charAt(0).toUpperCase() : '?';
                const item = document.createElement('div');
                item.className = 'friend-item';
                item.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        <div class="friend-avatar">${initial}</div>
                        <div class="friend-info">
                            <div class="friend-name">${f.firstName} ${f.lastName}</div>
                            <div class="friend-email">${f.email}</div>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right" style="color:var(--text-light)"></i>
                `;
                item.onclick = () => loadFriendCookbook(f);
                container.appendChild(item);
            });
        }

        async function loadFriendCookbook(friend) {
            document.getElementById('loader').style.display = 'flex';
            document.getElementById('friend-cookbook-title').innerText = `${friend.firstName}'s Cookbook`;
            friendRecipes = [];
            friendCategories = [];
            currentFriendFilter = "All";

            try {
                // Load friend's category colors (their settings)
                const settingsSnap = await getDoc(doc(db, "users", friend.uid, "data", "settings"));
                if (settingsSnap.exists() && Array.isArray(settingsSnap.data().categories)) {
                    friendCategories = settingsSnap.data().categories;
                } else {
                    friendCategories = [...appCategories];
                }

                // Load friend's recipes
                const q = query(collection(db, "users", friend.uid, "recipes"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    renderFriendCookbookFilters();
                    renderFriendCookbookRecipes();
                } else {
                    querySnapshot.forEach((docSnap) => {
                        const r = docSnap.data();
                        r.id = docSnap.id;
                        if (r.category && typeof r.category === 'string') r.category = [r.category];
                        friendRecipes.push(r);
                    });
                    renderFriendCookbookFilters();
                    renderFriendCookbookRecipes();
                }

                switchTab('friend-cookbook');
            } catch (err) {
                console.error(err);
                const grid = document.getElementById('friend-recipe-grid');
                if (grid) grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:var(--text-light)">Error loading cookbook.</div>';
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        window.copyFriendRecipe = async (rData) => {
            const data = {
                title: rData.title,
                category: rData.category,
                ingredients: rData.ingredients,
                instructions: rData.instructions,
                favorite: false
            };
            document.getElementById('loader').style.display = 'flex';
            const docRef = await addDoc(collection(db, "users", currentUser.uid, "recipes"), data);
            
            const newRecipe = { ...data, id: docRef.id };
            recipes.push(newRecipe);
            
            if(currentDashboardFilter === 'All' || (Array.isArray(newRecipe.category) ? newRecipe.category.includes(currentDashboardFilter) : newRecipe.category === currentDashboardFilter)) {
                 renderRecipes();
            }

            document.getElementById('loader').style.display = 'none';
            showToast("Recipe saved to your dashboard!");
        };

        function initCustomSelects() {
            setupCustomSelect('inv-cat-select');
            setupCustomSelect('groc-cat-select');
        }

        function setupCustomSelect(containerId) {
            const container = document.getElementById(containerId);
            if(!container) return;
            
            const select = container.querySelector('select');
            const existingSelected = container.querySelector('.select-selected');
            const existingItems = container.querySelector('.select-items');
            if(existingSelected) existingSelected.remove();
            if(existingItems) existingItems.remove();

            const selectedDiv = document.createElement("div");
            selectedDiv.setAttribute("class", "select-selected");
            selectedDiv.innerHTML = select.options[select.selectedIndex].innerHTML;
            container.appendChild(selectedDiv);

            const optionsDiv = document.createElement("div");
            optionsDiv.setAttribute("class", "select-items select-hide");

            for (let i = 0; i < select.length; i++) {
                const optionDiv = document.createElement("div");
                optionDiv.innerHTML = select.options[i].innerHTML;
                optionDiv.addEventListener("click", function(e) {
                    select.selectedIndex = i;
                    selectedDiv.innerHTML = this.innerHTML;
                    
                    const sameAsSelected = this.parentNode.querySelectorAll(".same-as-selected");
                    sameAsSelected.forEach(el => el.classList.remove("same-as-selected"));
                    this.setAttribute("class", "same-as-selected");
                    
                    selectedDiv.click(); 
                    select.dispatchEvent(new Event('change'));
                });
                optionsDiv.appendChild(optionDiv);
            }
            container.appendChild(optionsDiv);

            selectedDiv.addEventListener("click", function(e) {
                e.stopPropagation();
                closeAllSelect(this);
                this.nextSibling.classList.toggle("select-hide");
                this.classList.toggle("select-arrow-active");
            });
        }

        function closeAllSelect(elmnt) {
            const items = document.getElementsByClassName("select-items");
            const selected = document.getElementsByClassName("select-selected");
            const arrNo = [];
            for (let i = 0; i < selected.length; i++) {
                if (elmnt == selected[i]) {
                    arrNo.push(i)
                } else {
                    selected[i].classList.remove("select-arrow-active");
                }
            }
            for (let i = 0; i < items.length; i++) {
                if (arrNo.indexOf(i)) {
                    items[i].classList.add("select-hide");
                }
            }
        }
        document.addEventListener("click", closeAllSelect);

        window.toggleAuthMode = () => {
            isSignup = !isSignup;
            const title = document.getElementById('auth-title');
            const btn = document.querySelector('#auth-modal button');
            const toggle = document.querySelector('.auth-toggle');
            const error = document.getElementById('auth-error');
            const nameContainer = document.getElementById('auth-name-container');

            error.style.display = 'none';
            if(isSignup) { 
                title.innerText = "Create Account"; 
                btn.innerText = "Sign Up"; 
                toggle.innerText = "Already have an account? Log In";
                nameContainer.style.display = 'flex'; 
            } else { 
                title.innerText = "Welcome to Stocked"; 
                btn.innerText = "Log In"; 
                toggle.innerText = "Don't have an account? Sign Up"; 
                nameContainer.style.display = 'none'; 
            }
        };

        window.handleAuth = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-password').value;
            const errorEl = document.getElementById('auth-error');
            
            let first = '', last = '';
            if (isSignup) {
                first = document.getElementById('auth-first').value.trim();
                last = document.getElementById('auth-last').value.trim();
                if (!first || !last) {
                    errorEl.innerText = "Please enter your full name.";
                    errorEl.style.display = 'block';
                    return;
                }
            }

            try {
                if(isSignup) {
                    await createUserWithEmailAndPassword(auth, email, pass);
                    await initNewUserDB(first, last); 
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch (error) {
                errorEl.innerText = error.message;
                errorEl.style.display = 'block';
            }
        };

        window.handleLogout = () => signOut(auth);
        window.togglePasswordVisibility = () => {
            const input = document.getElementById('auth-password');
            const icon = document.querySelector('.password-toggle');
            if (input.type === "password") { input.type = "text"; icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash'); } 
            else { input.type = "password"; icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye'); }
        };

        async function initNewUserDB(firstName = '', lastName = '') {
            if(!currentUser) return;
            const defaultInv = [{ name: "Salt", category: "Spices & Seasonings", checked: true }, { name: "Garlic", category: "Produce", checked: true }];
            await setDoc(doc(db, "users", currentUser.uid, "data", "inventory"), { items: defaultInv });
            await setDoc(doc(db, "users", currentUser.uid, "data", "mealPlan"), { plan: {} });
            await setDoc(doc(db, "users", currentUser.uid, "data", "grocery"), { items: [] });
            await setDoc(doc(db, "users", currentUser.uid, "data", "settings"), { categories: appCategories });
            await saveProfile(); 

            await addDoc(collection(db, "users", currentUser.uid, "recipes"), {
                title: 'Avocado Toast', category: ['Breakfast'], ingredients: 'Bread\nAvocado', instructions: 'Toast bread.', favorite: true, id: Date.now()
            });
        }

        async function loadUserData() {
            document.getElementById('loader').style.display = 'flex';
            
            recipes = [];
            const q = query(collection(db, "users", currentUser.uid, "recipes"));
            const querySnapshot = await getDocs(q);
            querySnapshot.forEach((doc) => { 
                let data = doc.data();
                if (data.category && typeof data.category === 'string') {
                    data.category = [data.category]; 
                }
                recipes.push({ ...data, id: doc.id }); 
            });

            const invSnap = await getDoc(doc(db, "users", currentUser.uid, "data", "inventory"));
            inventory = invSnap.exists() ? invSnap.data().items : [];

            const mpSnap = await getDoc(doc(db, "users", currentUser.uid, "data", "mealPlan"));
            mealPlan = mpSnap.exists() ? mpSnap.data().plan : {};

            const grocSnap = await getDoc(doc(db, "users", currentUser.uid, "data", "grocery"));
            manualGrocery = grocSnap.exists() ? grocSnap.data().items : [];

            const friendsSnap = await getDoc(doc(db, "users", currentUser.uid, "data", "friends"));
            friends = friendsSnap.exists() ? friendsSnap.data().list : [];

            
            const defaultCats = Array.isArray(appCategories) ? appCategories.map(c => ({ name: c.name, color: c.color })) : [];
            const setSnap = await getDoc(doc(db, "users", currentUser.uid, "data", "settings"));
            if (setSnap.exists() && setSnap.data().categories) {
                const rawCats = setSnap.data().categories;

                // Backward compatibility: older saves may be ["Italian","Mexican",...]
                if (Array.isArray(rawCats) && rawCats.length > 0 && typeof rawCats[0] === 'string') {
                    appCategories = rawCats.map(name => {
                        const def = defaultCats.find(d => d.name === name);
                        return { name, color: def ? def.color : stringToColor(name) };
                    });
                } else {
                    appCategories = (Array.isArray(rawCats) ? rawCats : []).map(catObj => {
                        const name = (catObj && typeof catObj.name === 'string') ? catObj.name : String(catObj || 'Other');
                        const savedColor = (catObj && typeof catObj.color === 'string') ? catObj.color.trim() : '';
                        const def = defaultCats.find(d => d.name === name);

                        //  Prefer the user's saved color; only fall back when missing/invalid.
                        const isValidHex = /^#([0-9A-Fa-f]{3}){1,2}$/.test(savedColor);
                        const color = isValidHex ? savedColor : (def ? def.color : stringToColor(name));

                        return { name, color };
                    });

                    // Ensure at least one category exists
                    if (!appCategories.length) appCategories = defaultCats.length ? defaultCats : [{ name: "Other", color: "#34495E" }];
                }
            } else {
                await setDoc(doc(db, "users", currentUser.uid, "data", "settings"), { categories: appCategories });
            }
const profSnap = await getDoc(doc(db, "users", currentUser.uid, "data", "profile"));
            if(profSnap.exists()) userProfile = profSnap.data();
            else userProfile = { firstName: '', lastName: '' };

            renderGreeting();
            renderDashboardFilters();
            renderRecipes();
            renderMealPlan();
            renderInventory();
            renderFriendsList();
            generateGroceryList();
            document.getElementById('loader').style.display = 'none';
        }

        async function saveSettingsToCloud() {
            await setDoc(doc(db, "users", currentUser.uid, "data", "settings"), { categories: appCategories });
        }
        async function saveInventoryToCloud() { await setDoc(doc(db, "users", currentUser.uid, "data", "inventory"), { items: inventory }); }
        async function saveMealPlanToCloud() { await setDoc(doc(db, "users", currentUser.uid, "data", "mealPlan"), { plan: mealPlan }); }
        async function saveGroceryToCloud() { await setDoc(doc(db, "users", currentUser.uid, "data", "grocery"), { items: manualGrocery }); }

        window.saveAllData = async () => {
            const btn = document.getElementById('btn-global-save');
            const icon = btn.querySelector('i');
            icon.className = 'fas fa-spinner fa-spin';
            
            try {
                await Promise.all([
                    saveSettingsToCloud(),
                    saveInventoryToCloud(),
                    saveMealPlanToCloud(),
                    saveGroceryToCloud()
                ]);
                showToast("All changes saved to cloud!");
            } catch (e) {
                console.error(e);
                showToast("Error saving data");
            } finally {
                icon.className = 'fas fa-check';
                setTimeout(() => { icon.className = 'fas fa-save'; }, 2000);
            }
        };

        window.openConfirmModal = (message, callback) => {
            document.getElementById('confirm-message').innerText = message;
            confirmCallback = callback;
            document.getElementById('confirm-modal').classList.add('open');
        };
        window.closeConfirmModal = () => { document.getElementById('confirm-modal').classList.remove('open'); confirmCallback = null; };
        document.getElementById('confirm-yes-btn').onclick = () => { if (confirmCallback) confirmCallback(); window.closeConfirmModal(); };

        window.switchTab = (tabId) => {
            document.querySelectorAll('.page-section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');

            document.querySelectorAll('.nav-tabs button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.mobile-nav-item').forEach(btn => btn.classList.remove('active'));

            const friendBtn = document.getElementById('btn-friends-nav');
            if(friendBtn) friendBtn.classList.remove('active');

            if(window.innerWidth > 768) {
                if (tabId === 'friends' || tabId === 'friend-cookbook') {
                    if(friendBtn) friendBtn.classList.add('active');
                } else {
                    const tabs = ['dashboard', 'planning', 'substitutions'];
                    const index = tabs.indexOf(tabId);
                    if (index > -1) {
                        document.querySelectorAll('.nav-tabs button')[index].classList.add('active');
                    }
                }
            } else {
                const mobIndex = ['dashboard', 'planning', 'friends', 'substitutions'].indexOf(tabId);
                if(tabId === 'friend-cookbook') {
                      document.querySelectorAll('.mobile-nav-item')[2].classList.add('active');
                } else if(mobIndex > -1) {
                    document.querySelectorAll('.mobile-nav-item')[mobIndex].classList.add('active');
                }
            }
        };

        window.addEventListener('resize', () => {
            if(currentUser) {
                if(window.innerWidth > 768) {
                    document.getElementById('nav-actions').style.display = 'flex';
                    document.getElementById('mobile-nav').style.display = 'none';
                } else {
                    document.getElementById('nav-actions').style.display = 'none';
                    document.getElementById('mobile-nav').style.display = 'flex';
                }
            }
        });

        window.openCatManager = () => {
            renderCatManagerList();
            document.getElementById('cat-manager-modal').classList.add('open');
            selectedColor = PRESET_COLORS[0];
            initColorPicker();
        };
        window.closeCatManager = () => document.getElementById('cat-manager-modal').classList.remove('open');

        function renderCatManagerList() {
            const list = document.getElementById('manage-cat-list');
            list.innerHTML = '';
            const fragment = document.createDocumentFragment();
            appCategories.forEach((catObj, index) => {
                const li = document.createElement('li');
                li.className = 'cat-item';
                li.draggable = true;
                li.dataset.index = index;
                li.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        <span class="cat-grip"><i class="fas fa-grip-lines"></i></span>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span class="cat-color-dot" style="background:${catObj.color}" onclick="openEditColor(event, ${index})"></span> 
                            <span class="cat-name">${catObj.name}</span>
                        </div>
                    </div>
                    <i class="fas fa-trash-alt cat-delete" onclick="deleteCategory(${index})"></i>
                `;
                li.addEventListener('dragstart', handleDragStart);
                li.addEventListener('dragover', handleDragOver);
                li.addEventListener('drop', handleDrop);
                li.addEventListener('dragenter', handleDragEnter);
                li.addEventListener('dragleave', handleDragLeave);
                fragment.appendChild(li);
            });
            list.appendChild(fragment);
        }

        /* --- NEW: Edit Color Popup Logic --- */
        window.openEditColor = (e, index) => {
            e.stopPropagation();
            const popup = document.getElementById('edit-color-popup');
            popup.innerHTML = '';
            
            PRESET_COLORS.forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = color;
                swatch.onclick = async () => {
                    appCategories[index].color = color;
                    await saveSettingsToCloud();
                    renderCatManagerList();
                    renderDashboardFilters(); // Re-render filter pills to update color if used there
                    renderRecipes(); // Re-render recipes to update badge colors
                    renderMealPlan(); // Update planner colors
                    popup.style.display = 'none';
                };
                popup.appendChild(swatch);
            });

            // Position popup near the clicked dot
            const rect = e.target.getBoundingClientRect();
            popup.style.top = (rect.bottom + window.scrollY + 5) + 'px';
            popup.style.left = (rect.left + window.scrollX) + 'px';
            popup.style.display = 'flex';
        };

        window.addNewCategory = async () => {
            const input = document.getElementById('new-cat-name');
            const val = input.value.trim();
            if(!val) return;
            const clean = val.charAt(0).toUpperCase() + val.slice(1);
            if(!appCategories.some(c => c.name === clean)) {
                appCategories.push({ name: clean, color: selectedColor });
                await saveSettingsToCloud();
                renderCatManagerList();
                renderDashboardFilters();
            }
            input.value = '';
        };

        window.deleteCategory = (index) => {
            window.openConfirmModal("Remove this category?", async () => {
                appCategories.splice(index, 1);
                await saveSettingsToCloud();
                renderCatManagerList();
                renderDashboardFilters();
            });
        };

        let dragSrcEl = null;
        function handleDragStart(e) {
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            this.classList.add('dragging');
        }
        function handleDragOver(e) { if (e.preventDefault) e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; }
        function handleDragEnter(e) { this.classList.add('over'); }
        function handleDragLeave(e) { this.classList.remove('over'); }
        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            if (dragSrcEl !== this) {
                const oldIdx = parseInt(dragSrcEl.dataset.index);
                const newIdx = parseInt(this.dataset.index);
                const item = appCategories.splice(oldIdx, 1)[0];
                appCategories.splice(newIdx, 0, item);
                saveSettingsToCloud();
                renderCatManagerList();
                renderDashboardFilters();
            }
            return false;
        }

        window.saveRecipe = async () => {
            const id = document.getElementById('inp-id').value;
            const selectedTags = Array.from(document.querySelectorAll('#category-tag-container .tag-pill.selected')).map(el => el.dataset.name);
            const categories = selectedTags.length > 0 ? selectedTags : ['Other'];

            const data = {
                title: document.getElementById('inp-title').value,
                category: categories, 
                ingredients: document.getElementById('inp-ingredients').value,
                instructions: document.getElementById('inp-instructions').value,
            };
            if(!data.title) return alert("Title required");
            document.getElementById('loader').style.display = 'flex';
            if(id) {
                const recipeRef = doc(db, "users", currentUser.uid, "recipes", id);
                await updateDoc(recipeRef, data);
                const idx = recipes.findIndex(r => r.id === id);
                if(idx > -1) recipes[idx] = { ...recipes[idx], ...data };
            } else {
                data.favorite = false;
                const docRef = await addDoc(collection(db, "users", currentUser.uid, "recipes"), data);
                recipes.push({ ...data, id: docRef.id });
            }
            document.getElementById('loader').style.display = 'none';
            window.closeModal();
            renderRecipes();
            renderMealPlan(); 
            generateGroceryList();
        };

        window.deleteRecipe = (id) => {
            window.openConfirmModal("Permanently delete this recipe?", async () => {
                document.getElementById('loader').style.display = 'flex';
                await deleteDoc(doc(db, "users", currentUser.uid, "recipes", id));
                recipes = recipes.filter(r => r.id !== id);
                let planChanged = false;
                Object.keys(mealPlan).forEach(key => {
                    if(mealPlan[key].recipeId === id) { delete mealPlan[key]; planChanged = true; }
                });
                if(planChanged) await saveMealPlanToCloud();
                document.getElementById('loader').style.display = 'none';
                renderRecipes();
                renderMealPlan();
                generateGroceryList();
            });
        };

        window.toggleFav = async (id) => {
            const r = recipes.find(x => x.id === id);
            if(r) {
                r.favorite = !r.favorite;
                renderRecipes(); 
                const recipeRef = doc(db, "users", currentUser.uid, "recipes", id);
                await updateDoc(recipeRef, { favorite: r.favorite });
            }
        };

        window.openModal = (editId = null) => {
            document.getElementById('recipe-modal').classList.add('open');
            const container = document.getElementById('category-tag-container');
            container.innerHTML = '';

            appCategories.forEach(catObj => {
                const pill = document.createElement('div');
                pill.className = 'tag-pill';
                pill.dataset.name = catObj.name; 
                pill.innerHTML = `<span class="tag-color-dot" style="background:${catObj.color}"></span> ${catObj.name}`;
                pill.onclick = () => pill.classList.toggle('selected');
                container.appendChild(pill);
            });

            if (editId) {
                const r = recipes.find(x => x.id === editId);
                document.getElementById('modal-title').innerText = "Edit Recipe";
                document.getElementById('inp-id').value = r.id;
                document.getElementById('inp-title').value = r.title;
                
                const activeCats = Array.isArray(r.category) ? r.category : [r.category];
                Array.from(container.children).forEach(pill => {
                    if (activeCats.includes(pill.dataset.name)) pill.classList.add('selected');
                });

                document.getElementById('inp-ingredients').value = r.ingredients;
                document.getElementById('inp-instructions').value = r.instructions;
            } else {
                document.getElementById('modal-title').innerText = "New Recipe";
                document.getElementById('inp-id').value = '';
                document.getElementById('inp-title').value = '';
                document.getElementById('inp-ingredients').value = '';
                document.getElementById('inp-instructions').value = '';
            }
        };
        
        window.closeModal = () => document.getElementById('recipe-modal').classList.remove('open');
        window.editRecipe = (id) => window.openModal(id);

        function renderDashboardFilters() {
            const container = document.getElementById('dashboard-filters');
            container.innerHTML = '';
            const displayCats = ["All", ...appCategories.map(c => c.name)];
            
            displayCats.forEach(catName => {
                const btn = document.createElement('button');
                btn.className = `filter-pill ${currentDashboardFilter === catName ? 'active' : ''}`;
                btn.innerText = catName;
                btn.onclick = () => { currentDashboardFilter = catName; renderDashboardFilters(); renderRecipes(); };
                container.appendChild(btn);
            });
        }

        function getColorForCategory(catName) {
            const found = appCategories.find(c => c.name === catName);
            return found ? found.color : stringToColor(catName);
        }

        function getColorForCategoryFrom(categoryList, catName) {
            const found = (categoryList || []).find(c => c.name === catName);
            if (found && found.color) return found.color;
            // fallback to app categories if friend categories missing
            return getColorForCategory(catName);
        }

        function renderFriendCookbookFilters() {
            const container = document.getElementById('friend-cookbook-filters');
            if (!container) return;
            container.innerHTML = '';

            const friendCatNames = (friendCategories || []).map(c => c.name);
            const recipeCats = Array.from(new Set(friendRecipes.flatMap(r => {
                const cats = Array.isArray(r.category) ? r.category : [r.category || 'Other'];
                return cats.filter(Boolean);
            })));

            // Order: friend's defined categories first, then any extra categories found in recipes
            const ordered = [...friendCatNames, ...recipeCats.filter(c => !friendCatNames.includes(c))];
            const displayCats = ["All", ...ordered];

            displayCats.forEach(catName => {
                const btn = document.createElement('button');
                btn.className = `filter-pill ${currentFriendFilter === catName ? 'active' : ''}`;
                btn.innerText = catName;
                btn.onclick = () => {
                    currentFriendFilter = catName;
                    renderFriendCookbookFilters();
                    renderFriendCookbookRecipes();
                };
                container.appendChild(btn);
            });

            // Count badge
            const badge = document.getElementById('friend-total-recipe-count');
            if (badge) {
                const count = currentFriendFilter === "All"
                    ? friendRecipes.length
                    : friendRecipes.filter(r => {
                        const cats = Array.isArray(r.category) ? r.category : [r.category || 'Other'];
                        return cats.includes(currentFriendFilter);
                    }).length;
                badge.innerText = `${count}`;
            }
        }

        function renderFriendCookbookRecipes() {
            const grid = document.getElementById('friend-recipe-grid');
            if (!grid) return;
            grid.innerHTML = '';

            const list = currentFriendFilter === "All"
                ? friendRecipes
                : friendRecipes.filter(r => {
                    const cats = Array.isArray(r.category) ? r.category : [r.category || 'Other'];
                    return cats.includes(currentFriendFilter);
                });

            if (!list.length) {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:var(--text-light)">No recipes match this category.</div>';
                return;
            }

            const fragment = document.createDocumentFragment();
            list.forEach(r => {
                const cats = Array.isArray(r.category) ? r.category : [r.category || 'Other'];

                const card = document.createElement('div');
                card.className = 'recipe-card';

                let badgesHtml = '<div class="cat-badges">';
                cats.forEach(c => {
                    const badgeColor = getColorForCategoryFrom(friendCategories, c);
                    badgesHtml += `<div class="cat-badge" style="background-color:${badgeColor}; color:#fff; border:1px solid rgba(0,0,0,0.1); text-shadow:0 1px 2px rgba(0,0,0,0.2);">${c}</div>`;
                });
                badgesHtml += '</div>';

                const formattedInst = formatInstructionsHTML(r.instructions);

                card.innerHTML = `
                    <div class="card-header">
                        <div style="flex-grow:1;">
                            ${badgesHtml}
                            <div class="recipe-title">${r.title}</div>
                        </div>
                    </div>
                    <div class="clickable-area" onclick="openViewModal('${r.id}', true)">
                        <div class="recipe-details">
                            <h4>Ingredients</h4>
                            <ul>${(r.ingredients || '').split('\n').filter(Boolean).map(i=>`<li>${i}</li>`).join('')}</ul>
                        </div>
                        <div class="recipe-details" style="margin-top:10px;">
                            <h4>Instructions</h4>
                            <div class="instruction-preview">${formattedInst}</div>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="primary" style="width:100%;" onclick="event.stopPropagation(); saveFriendRecipeToMyRecipes('${r.id}');">
                            <i class="fas fa-download"></i> Save to My Books
                        </button>
                    </div>
                `;
                fragment.appendChild(card);
            });
            grid.appendChild(fragment);
        }


        window.openViewModal = (id, readOnly = false) => {
            const source = readOnly ? friendRecipes : recipes;
            const r = source.find(x => x.id === id);
            if(!r) return;

            document.getElementById('view-modal-title').innerText = r.title;

            const badgesContainer = document.getElementById('view-modal-badges');
            const cats = Array.isArray(r.category) ? r.category : [r.category || 'Other'];
            let badgesHtml = '';
            cats.forEach(c => {
                const badgeColor = readOnly ? getColorForCategoryFrom(friendCategories, c) : getColorForCategory(c);
                badgesHtml += `<div class="cat-badge" style="background-color:${badgeColor}; color:#fff; border:1px solid rgba(0,0,0,0.1); text-shadow:0 1px 2px rgba(0,0,0,0.2);">${c}</div>`;
            });
            badgesContainer.innerHTML = badgesHtml;

            const ingList = document.getElementById('view-ingredients');
            const multiplier = r.currentMultiplier || 1.0;
            ingList.innerHTML = formatScaledIngredients(r.ingredients, multiplier);

            document.getElementById('view-instructions').innerHTML = formatInstructionsHTML(r.instructions);

            const editBtn = document.getElementById('view-btn-edit');
            editBtn.style.display = readOnly ? 'none' : 'inline-flex';

            document.getElementById('view-btn-cook').onclick = () => { 
                closeViewModal(); 
                if (readOnly) {
                    openCookModeFromData(r);
                } else {
                    openCookMode(r.id);
                }
            };

            if (!readOnly) {
                editBtn.onclick = () => { closeViewModal(); editRecipe(r.id); };
            } else {
                editBtn.onclick = null;
            }

            document.getElementById('view-btn-copy').onclick = () => {
                const text = `${r.title}\n\nINGREDIENTS:\n${r.ingredients}\n\nINSTRUCTIONS:\n${r.instructions}`;
                navigator.clipboard.writeText(text);
                showToast("Recipe copied to clipboard");
            };

            document.getElementById('view-recipe-modal').classList.add('open');
        };

        window.closeViewModal = () => document.getElementById('view-recipe-modal').classList.remove('open');

        /* --- SEARCH LOGIC --- */
        window.handleSearch = (val) => {
            const clearBtn = document.getElementById('clear-search-btn');
            // Immediate UI feedback for the X button
            if(val.trim().length > 0) {
                clearBtn.style.display = 'block';
            } else {
                clearBtn.style.display = 'none';
            }

            // Debounce the heavy rendering
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentSearchQuery = val.trim();
                renderRecipes();
            }, 300); // 300ms delay
        };

        window.clearSearch = () => {
            document.getElementById('recipe-search').value = '';
            handleSearch('');
        };

        function renderRecipes() {
            const grid = document.getElementById('recipe-grid');
            const countEl = document.getElementById('total-recipe-count');
            grid.innerHTML = '';
            
            recipes.sort((a, b) => {
                if (a.favorite === b.favorite) {
                    return a.title.toLowerCase().localeCompare(b.title.toLowerCase());
                }
                return a.favorite ? -1 : 1;
            });
            
            const filtered = recipes.filter(r => {
                const cats = Array.isArray(r.category) ? r.category : [r.category];
                const catMatch = currentDashboardFilter === "All" || cats.includes(currentDashboardFilter);
                
                // Add Search Logic
                const titleMatch = r.title.toLowerCase().includes(currentSearchQuery.toLowerCase());

                return catMatch && titleMatch;
            });
            
            countEl.innerText = `${filtered.length} Recipe${filtered.length !== 1 ? 's' : ''}`;

            if (recipes.length === 0) {
                 grid.innerHTML = `<div style="grid-column: 1/-1; text-align:center; padding: 2rem; color:var(--text-light);">
                    <div style="font-size: 1.2rem; font-weight: 500;">Add a recipe to get started!</div>
                 </div>`;
                 return;
            }

            if(filtered.length === 0) {
                if(currentSearchQuery.length > 0) {
                    grid.innerHTML = `<p style="grid-column: 1/-1; text-align:center; color:var(--text-light);">No recipes found matching "${currentSearchQuery}".</p>`;
                } else {
                    grid.innerHTML = `<p style="grid-column: 1/-1; text-align:center; color:var(--text-light);">No recipes found for "${currentDashboardFilter}".</p>`;
                }
                return;
            }

            const fragment = document.createDocumentFragment();
            filtered.forEach(r => {
                const cats = Array.isArray(r.category) ? r.category : [r.category || 'Other'];
                const card = document.createElement('div');
                card.className = 'recipe-card draggable';
                card.draggable = true;
                card.ondragstart = (e) => drag(e, r.id);
                
                let badgesHtml = '<div class="cat-badges">';
                cats.forEach(c => {
                    const badgeColor = getColorForCategory(c);
                    badgesHtml += `<div class="cat-badge" style="background-color: ${badgeColor}; color: white; border:1px solid rgba(0,0,0,0.1); text-shadow:0 1px 2px rgba(0,0,0,0.2);">${c}</div>`;
                });
                badgesHtml += '</div>';

                const multiplier = r.currentMultiplier || 1.0;
                const scaledIngredients = formatScaledIngredients(r.ingredients, multiplier);
                const formattedInst = formatInstructionsHTML(r.instructions);

                card.innerHTML = `
                    <div class="card-header">
                        <div style="flex-grow:1;">
                            ${badgesHtml}
                            <div class="recipe-title">${r.title}</div>
                        </div>
                        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:5px;">
                            <button class="fav-btn ${r.favorite ? 'active' : ''}" onclick="toggleFav('${r.id}')"><i class="${r.favorite ? 'fas' : 'far'} fa-star"></i></button>
                            <div class="multiplier-badge">
                                <button class="mult-btn" onclick="updateMultiplier(this, -0.5)">-</button>
                                <span class="mult-val">${multiplier}x</span>
                                <button class="mult-btn" onclick="updateMultiplier(this, 0.5)">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="clickable-area" onclick="openViewModal('${r.id}')">
                        <div class="recipe-details">
                            <h4>Ingredients</h4>
                            <ul class="ingredient-list" data-original="${encodeURIComponent(r.ingredients)}">${scaledIngredients}</ul>
                        </div>
                        <div class="recipe-details"><h4>Instructions</h4><div class="instruction-preview">${formattedInst}</div></div>
                    </div>

                    <div class="card-actions">
                         <div style="display:flex; align-items:center; gap:10px;">
                             <button class="btn-cook" onclick="openCookMode('${r.id}')"><i class="fas fa-fire"></i> Cook</button>
                         </div>
                         <div class="action-buttons">
                            <button class="btn-icon" onclick="editRecipe('${r.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn-icon delete" onclick="deleteRecipe('${r.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
                fragment.appendChild(card);
            });
            grid.appendChild(fragment);
        }

        window.drag = (ev, id) => { ev.dataTransfer.setData("recipeId", id); };
        window.allowDrop = (ev) => { ev.preventDefault(); ev.target.closest('.meal-slot').classList.add('drag-over'); };
        window.drop = (ev) => {
            ev.preventDefault();
            const slot = ev.target.closest('.meal-slot');
            slot.classList.remove('drag-over');
            const id = ev.dataTransfer.getData("recipeId");
            if(!id) return;
            updateMealSlot(slot.dataset.day, slot.dataset.type, id);
        };

        window.openMealSelector = (day, type) => {
            activeSlot = { day, type };
            currentPickerFilter = "All";
            renderPickerFilters();
            renderPickerList();
            document.getElementById('selector-modal').classList.add('open');
        };
        window.closeSelectorModal = () => document.getElementById('selector-modal').classList.remove('open');

        function renderPickerFilters() {
            const container = document.getElementById('picker-filters');
            container.innerHTML = '';
            const displayCats = ["All", ...appCategories.map(c => c.name)];
            displayCats.forEach(catName => {
                const btn = document.createElement('button');
                btn.className = `filter-pill ${currentPickerFilter === catName ? 'active' : ''}`;
                btn.innerText = catName;
                btn.onclick = () => { currentPickerFilter = catName; renderPickerFilters(); renderPickerList(); };
                container.appendChild(btn);
            });
        }

        function renderPickerList() {
            const list = document.getElementById('picker-list');
            list.innerHTML = '';
            if(recipes.length === 0) { list.innerHTML = '<li style="padding:1rem; color:#777;">Add recipes to dashboard first.</li>'; return; }
            
            const filtered = currentPickerFilter === "All" 
                ? recipes 
                : recipes.filter(r => {
                    const cats = Array.isArray(r.category) ? r.category : [r.category];
                    return cats.includes(currentPickerFilter);
                });

            if(filtered.length === 0) { list.innerHTML = '<li style="padding:1rem; color:#777;">No matching recipes found.</li>'; return; }
            
            const fragment = document.createDocumentFragment();
            filtered.forEach(r => {
               const li = document.createElement('li');
               li.className = 'picker-item';
               li.innerHTML = `<span><strong>${r.title}</strong></span><i class="fas fa-plus"></i>`;
               li.onclick = () => { updateMealSlot(activeSlot.day, activeSlot.type, r.id); window.closeSelectorModal(); };
               fragment.appendChild(li);
            });
            list.appendChild(fragment);
        }

        async function updateMealSlot(day, type, recipeId) {
            const key = `${day}-${type}`;
            mealPlan[key] = { recipeId, day, type };
            renderMealPlan();
            generateGroceryList();
            await saveMealPlanToCloud();
        }

        window.removeFromPlan = async (e, key) => { e.stopPropagation(); delete mealPlan[key]; renderMealPlan(); generateGroceryList(); await saveMealPlanToCloud(); };
        window.clearWeeklyPlan = () => {
            window.openConfirmModal("Clear the entire week's plan?", async () => {
                document.getElementById('loader').style.display = 'flex';
                mealPlan = {};
                await saveMealPlanToCloud();
                renderMealPlan();
                generateGroceryList();
                document.getElementById('loader').style.display = 'none';
            });
        };
        // =====================================================================
        // 8) VIEW WEEK (Modal: deduped recipe cards + day filter)
        // =====================================================================
        // --- Weekly Planned Recipes (View Week Modal) ---
        const WEEK_DAY_LABELS = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
        const WEEK_DAY_FULL = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
        const WEEK_TYPE_LABELS = {
            'break': 'Breakfast',
            'lunch': 'Lunch',
            'dinner-main': 'Dinner',
            'dinner-side': 'Side'
        };

        // -1 = Whole week (no day filter)
        let currentWeekDayFilter = -1;

        function setWeekDayFilter(dayIdx) {
            currentWeekDayFilter = Number(dayIdx);
            renderWeekDayFilters();
            renderWeekRecipesList();
        }

        function renderWeekDayFilters() {
            const container = document.getElementById('week-day-filters');
            if (!container) return;

            container.innerHTML = '';

            const makeBtn = (label, value) => {
                const btn = document.createElement('button');
                btn.className = `filter-pill ${currentWeekDayFilter === value ? 'active' : ''}`;
                btn.type = 'button';
                btn.innerText = label;
                btn.onclick = () => setWeekDayFilter(value);
                return btn;
            };

            container.appendChild(makeBtn('Week', -1));
            WEEK_DAY_LABELS.forEach((d, idx) => container.appendChild(makeBtn(d, idx)));
        }

        function buildWeekPlannedRecipesDetailed() {
            const map = new Map();

            Object.keys(mealPlan || {}).forEach(key => {
                const plan = mealPlan[key];
                if (!plan) return;

                const recipe = recipes.find(r => r.id === plan.recipeId);
                if (!recipe) return;

                const dayIdx = Number(plan.day);
                const dayShort = WEEK_DAY_LABELS[dayIdx] || `Day ${plan.day}`;
                const mealLabel = WEEK_TYPE_LABELS[plan.type] || plan.type;

                if (!map.has(recipe.id)) map.set(recipe.id, { recipe, slots: [] });
                map.get(recipe.id).slots.push({
                    day: dayIdx,
                    type: plan.type,
                    label: `${dayShort} ${mealLabel}`
                });
            });

            return Array.from(map.values()).sort((a, b) =>
                (a.recipe.title || '').toLowerCase().localeCompare((b.recipe.title || '').toLowerCase())
            );
        }

        function renderWeekRecipesList() {
            const grid = document.getElementById('week-recipes-grid');
            const summary = document.getElementById('week-recipes-summary');
            if (!grid || !summary) return;

            grid.innerHTML = '';
            const allItems = buildWeekPlannedRecipesDetailed();

            const filteredItems = currentWeekDayFilter >= 0
                ? allItems.filter(({ slots }) => (slots || []).some(s => s.day === currentWeekDayFilter))
                : allItems;

            const dayName = currentWeekDayFilter >= 0 ? (WEEK_DAY_FULL[currentWeekDayFilter] || WEEK_DAY_LABELS[currentWeekDayFilter]) : 'this week';

            if (!filteredItems.length) {
                if (currentWeekDayFilter >= 0) {
                    summary.innerText = `No recipes planned for ${dayName} yet.`;
                } else {
                    summary.innerText = 'No recipes planned yet. Add meals to your week to see them here.';
                }
                grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:var(--text-light); padding: 2rem 0;">No planned recipes yet.</div>`;
                return;
            }

            if (currentWeekDayFilter >= 0) {
                summary.innerText = `${filteredItems.length} recipe${filteredItems.length === 1 ? '' : 's'} planned for ${dayName}.`;
            } else {
                summary.innerText = `${filteredItems.length} recipe${filteredItems.length === 1 ? '' : 's'} planned this week.`;
            }

            const fragment = document.createDocumentFragment();
            filteredItems.forEach(({ recipe, slots }) => {
                const cats = Array.isArray(recipe.category) ? recipe.category : [recipe.category || 'Other'];
                const card = document.createElement('div');
                card.className = 'recipe-card';

                let badgesHtml = '<div class="cat-badges">';
                cats.forEach(c => {
                    const badgeColor = getColorForCategory(c);
                    badgesHtml += `<div class="cat-badge" style="background-color: ${badgeColor}; color: white; border:1px solid rgba(0,0,0,0.1); text-shadow:0 1px 2px rgba(0,0,0,0.2);">${c}</div>`;
                });
                badgesHtml += '</div>';

                const slotsToShow = (currentWeekDayFilter >= 0)
                    ? (slots || []).filter(s => s.day === currentWeekDayFilter)
                    : (slots || []);

                const slotBadges = slotsToShow
                    .slice()
                    .sort((a, b) => (a.label || '').localeCompare(b.label || ''))
                    .map(s => `<span class="week-slot-badge">${s.label}</span>`)
                    .join('');

                const multiplier = recipe.currentMultiplier || 1.0;
                const scaledIngredients = formatScaledIngredients(recipe.ingredients, multiplier);
                const formattedInst = formatInstructionsHTML(recipe.instructions);

                card.innerHTML = `
                    <div class="card-header">
                        <div style="flex-grow:1;">
                            ${badgesHtml}
                            <div class="recipe-title">${recipe.title}</div>
                            <div class="week-slot-badges">${slotBadges}</div>
                        </div>
                    </div>

                    <div class="clickable-area" onclick="openViewModal('${recipe.id}')">
                        <div class="recipe-details">
                            <h4>Ingredients</h4>
                            <ul>${scaledIngredients}</ul>
                        </div>
                        <div class="recipe-details"><h4>Instructions</h4><div class="instruction-preview">${formattedInst}</div></div>
                    </div>

                    <div class="card-actions">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <button class="btn-cook" onclick="event.stopPropagation(); openCookMode('${recipe.id}')"><i class="fas fa-fire"></i> Cook</button>
                        </div>
                        <div class="action-buttons"></div>
                    </div>
                `;

                fragment.appendChild(card);
            });
            grid.appendChild(fragment);
        }

        window.openWeekRecipesModal = () => {
            currentWeekDayFilter = -1;
            renderWeekDayFilters();
            renderWeekRecipesList();
            document.getElementById('week-recipes-modal').classList.add('open');
        };
        window.closeWeekRecipesModal = () => document.getElementById('week-recipes-modal').classList.remove('open');


        function renderMealPlan() {
            document.querySelectorAll('.meal-slot').forEach(slot => {
                slot.innerHTML = '<span class="slot-placeholder"><i class="fas fa-plus"></i></span>';
                slot.onclick = () => window.openMealSelector(slot.dataset.day, slot.dataset.type);
            });
            Object.keys(mealPlan).forEach(key => {
                const plan = mealPlan[key];
                const recipe = recipes.find(r => r.id === plan.recipeId);
                const slot = document.querySelector(`.meal-slot[data-day="${plan.day}"][data-type="${plan.type}"]`);
                if (recipe && slot) {
                    slot.onclick = null; 
                    const firstCatName = Array.isArray(recipe.category) ? recipe.category[0] : recipe.category;
                    const color = getColorForCategory(firstCatName || 'Other');
                    slot.innerHTML = `
                        <div class="planned-meal" style="border-left-color: ${color}">
                            <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${recipe.title}</span>
                            <i class="fas fa-times remove-meal" onclick="removeFromPlan(event, '${key}')"></i>
                        </div>
                    `;
                }
            });

            // If the week modal is open, keep it live-updated.
            const weekOverlay = document.getElementById('week-recipes-modal');
            if (weekOverlay && weekOverlay.classList.contains('open')) {
                renderWeekRecipesList();
            }
        }

        function renderInventory() {
            const container = document.getElementById('inventory-list-container');
            container.innerHTML = '';
            INVENTORY_CATEGORIES.forEach(cat => {
                const catItems = inventory.filter(i => i.category === cat).sort((a,b)=>a.name.localeCompare(b.name));
                if(catItems.length > 0) {
                    container.innerHTML += `<div class="inv-category-header">${cat}</div>`;
                    catItems.forEach(item => {
                        const idx = inventory.indexOf(item);
                        container.innerHTML += `
                            <div class="inventory-item-row">
                                <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="toggleInventory(${idx})">
                                <label>${item.name}</label>
                                <i class="fas fa-times delete-item" onclick="deleteInventoryItem(${idx})"></i>
                            </div>
                        `;
                    });
                }
            });
        }

        window.toggleInventory = async (idx) => { inventory[idx].checked = !inventory[idx].checked; renderInventory(); generateGroceryList(); await saveInventoryToCloud(); };
        window.deleteInventoryItem = async (idx) => { inventory.splice(idx, 1); renderInventory(); generateGroceryList(); await saveInventoryToCloud(); };
        window.addInventoryItem = async () => {
            const name = document.getElementById('new-inventory-item').value.trim();
            const cat = document.getElementById('new-item-category').value;
            if(!name) return;
            const clean = name.charAt(0).toUpperCase() + name.slice(1);
            if(inventory.find(i=>i.name.toLowerCase()===clean.toLowerCase())) {
                openAlertModal('That ingredient is already in your on-hand list.', 'Ingredient already added', 'fa-info-circle');
                return;
            }
            inventory.push({ name: clean, category: cat, checked: true });
            document.getElementById('new-inventory-item').value = '';
            renderInventory(); generateGroceryList(); await saveInventoryToCloud();
        };

        // Clears all "Ingredients on Hand" items (inventory) after confirmation.
        window.clearInventoryConfirm = () => {
            if (!inventory || inventory.length === 0) {
                showToast('No ingredients to clear');
                return;
            }
            openConfirmModal('Are you sure you want to clear all ingredients on hand?', async () => {
                inventory = [];
                renderInventory();
                generateGroceryList();
                await saveInventoryToCloud();
                showToast('Ingredients cleared');
            });
        };

        function detectCategory(name) {
            name = name.toLowerCase();
            for (const [cat, keywords] of Object.entries(CATEGORY_KEYWORDS)) { if (keywords.some(k => name.includes(k))) return cat; }
            return "Other";
        }

        window.addManualGroceryItem = async () => {
            const name = document.getElementById('manual-grocery-item').value.trim();
            const cat = document.getElementById('manual-grocery-category').value;
            if(!name) return;
            const clean = name.charAt(0).toUpperCase() + name.slice(1);
            manualGrocery.push({ name: clean, category: cat, isManual: true });
            document.getElementById('manual-grocery-item').value = '';
            generateGroceryList(); await saveGroceryToCloud();
        };

        window.removeManualItem = async (idx) => { manualGrocery.splice(idx, 1); generateGroceryList(); await saveGroceryToCloud(); };

                function normalizeIngredientForMatch(name) {
                    if(!name) return '';
                    name = name.toLowerCase();

                    // Keep size info like "(15 oz)" by inlining it before removing parentheses.
                    name = name.replace(/\((\s*\d+(?:\.\d+)?\s*(?:oz|ounce|ounces|lb|lbs|pound|pounds|g|gram|grams|kg|ml|l|liter|liters)\s*)\)/gi, ' $1 ');

                    // Remove remaining parentheticals and common trailing prep notes.
                    name = name.replace(/\([^)]*\)/g, ' ');
                    name = name.replace(/\s*,\s*(?:drained|drain|rinsed|peeled|seeded|cored|minced|diced|chopped|sliced|grated|shredded|softened|melted|room\s+temperature|divided|optional|to\s+taste|for\s+garnish|for\s+serving|plus\s+more.*|more\s+as\s+needed.*).*$/i, ' ');

                    // Normalize punctuation/spaces
                    name = name.replace(/[]/g, ' ');
                    name = name.replace(/[^\w\s\/\.-]/g, ' ');
                    name = name.replace(/\s+/g, ' ').trim();

                    // Remove leading quantity/unit/container words for matching
                    name = name.replace(/^[\d\s\/\.\u00BC-\u00BE\u2150-\u215E\-]+/, '').trim();

                    const removeWords = new Set([
                        'of','a','an','the','and','or','to',
                        'fresh','large','small','medium',
                        'finely','roughly','coarsely',
                        'optional','divided'
                    ]);
                    const tokens = name.split(' ').filter(Boolean).filter(t => !removeWords.has(t));

                    // Very light singularization (avoids over-aggressive stemming)
                    const singular = tokens.map(t => {
                        if(t.endsWith('ies') && t.length > 3) return t.slice(0,-3) + 'y';
                        if(t.endsWith('ses') && t.length > 3) return t.slice(0,-2); // e.g., "tomatoes" -> "tomato" handled below
                        if(t.endsWith('oes') && t.length > 3) return t.slice(0,-2); // tomatoes -> tomato
                        if(t.endsWith('s') && !t.endsWith('ss') && t.length > 3) return t.slice(0,-1);
                        return t;
                    });

                    return singular.join(' ').trim();
                }


                // Tokenize ingredient names for fuzzy matching between recipe lines and pantry items.
                // This intentionally ignores prep notes and packaging words so "artichoke hearts (drained and chopped)"
                // can match "artichoke hearts" (or even just "artichoke").
                function tokenizeForMatch(name) {
                    if(!name) return new Set();
                    const base = normalizeIngredientForMatch(name);
                    const stop = new Set([
                        'oz','ounce','ounces','lb','lbs','pound','pounds','g','gram','grams','kg','ml','l','liter','liters',
                        'cup','cups','tbsp','tablespoon','tablespoons','tsp','teaspoon','teaspoons',
                        'can','cans','jar','jars','package','packages','pkg','pkgs','bag','bags','bottle','bottles','box','boxes',
                        'clove','cloves','slice','slices','stick','sticks','bunch','head','handful','pinch','dash',
                        'about','approx','approximately'
                    ]);
                    return new Set(
                        base.split(' ')
                            .map(t => t.trim())
                            .filter(Boolean)
                            .filter(t => t.length > 1 && !stop.has(t))
                    );
                }

                // Lightweight disambiguation to avoid common false positives when using "any-word" matching.
                // Example: "pepper" (black pepper) should not always match "bell pepper".
                const DISAMBIGUATION = {
                    pepper: ['bell','black','jalapeno','chili','cayenne','red','green'],
                    sugar: ['brown','powdered','confectioner','granulated'],
                    flour: ['almond','coconut','bread','allpurpose','all-purpose','wholewheat','whole-wheat'],
                    milk: ['almond','oat','soy','coconut','skim','whole','2','2%'],
                    oil: ['olive','vegetable','canola','sesame','coconut'],
                    cheese: ['parmesan','mozzarella','cheddar','feta','goat','cream']
                };

                function disambiguationAllowsMatch(aTokens, bTokens) {
                    for (const base in DISAMBIGUATION) {
                        if(aTokens.has(base) && bTokens.has(base)) {
                            const quals = DISAMBIGUATION[base];
                            const aQ = quals.filter(q => aTokens.has(q));
                            const bQ = quals.filter(q => bTokens.has(q));

                            // If neither side specifies a qualifier, allow.
                            if(aQ.length === 0 && bQ.length === 0) continue;

                            // If one specifies a qualifier and the other does not, block match.
                            if(aQ.length === 0 || bQ.length === 0) return false;

                            // If both specify qualifiers but none overlap, block match.
                            const overlap = aQ.some(q => bQ.includes(q));
                            if(!overlap) return false;
                        }
                    }
                    return true;
                }

                function isOnHandMatch(neededObj, onHandObj) {
                    if(!neededObj || !neededObj.key || !onHandObj || !onHandObj.key) return false;

                    // Exact normalized key match first (fast path).
                    if(neededObj.key === onHandObj.key) return true;

                    const a = neededObj._tokens || (neededObj._tokens = tokenizeForMatch(neededObj.item || neededObj.display || neededObj.key));
                    const b = onHandObj.tokens;

                    // Guardrails for ambiguous base words (pepper/sugar/etc.)
                    if(!disambiguationAllowsMatch(a, b)) return false;

                    // "Any meaningful word" overlap matches.
                    for(const t of a) {
                        if(b.has(t)) return true;
                    }
                    return false;
                }

                function parseIngredientLine(text) {
                    if(!text) return null;
                    let raw = String(text).trim();
                    if(!raw) return null;

                    // Remove bullets
                    raw = raw.replace(/^[\-\*\u2022]\s*/, '');

                    // Inline size parentheses like "(15 oz)"
                    raw = raw.replace(/\((\s*\d+(?:\.\d+)?\s*(?:oz|ounce|ounces|lb|lbs|pound|pounds|g|gram|grams|kg|ml|l|liter|liters)\s*)\)/gi, ' $1 ');

                    // Remove remaining parentheticals and trailing prep notes
                    let cleaned = raw.replace(/\([^)]*\)/g, ' ');
                    cleaned = cleaned.replace(/\s*,\s*(?:drained|drain|rinsed|peeled|seeded|cored|minced|diced|chopped|sliced|grated|shredded|softened|melted|room\s+temperature|divided|optional|to\s+taste|for\s+garnish|for\s+serving|plus\s+more.*|more\s+as\s+needed.*).*$/i, ' ');
                    cleaned = cleaned.replace(/\s+/g, ' ').trim();

                    // Normalize patterns like "14-ounce" or "14oz"
                    cleaned = cleaned.replace(/(\d)\s*-\s*(?=[a-zA-Z])/g, '$1 ');
                    cleaned = cleaned.replace(/(\d)(oz|lb|g|kg|ml|l)\b/gi, '$1 $2');

                    let qty = '';
                    let packSize = '';
                    let unit = '';
                    let container = '';

                    // Capture leading quantity (supports "1 1/2", "1/2", unicode fractions)
                    const qtyMatch = cleaned.match(/^(\d+\s+\d+\/\d+|\d+\/\d+|\d+(?:\.\d+)?|[]+)(?:\s*(?:-|to)\s*(\d+(?:\.\d+)?|\d+\/\d+))?\b/i);
                    if(qtyMatch) {
                        qty = qtyMatch[0].trim();
                        cleaned = cleaned.slice(qtyMatch[0].length).trim();
                    }

                    // Capture pack size like "15 oz" that comes after quantity: "2 15 oz cans ..."
                    const packMatch = cleaned.match(/^(\d+(?:\.\d+)?|\d+\/\d+)\s*(oz|ounce|ounces|lb|lbs|pound|pounds|g|gram|grams|kg|ml|l|liter|liters)\b/i);
                    if(packMatch) {
                        const u = packMatch[2].toLowerCase();
                        const uNorm = (u.startsWith('ounce') || u === 'oz') ? 'oz'
                                    : (u.startsWith('pound') || u === 'lb' || u === 'lbs') ? 'lb'
                                    : (u === 'gram' || u === 'grams' || u === 'g') ? 'g'
                                    : (u === 'kilogram' || u === 'kg') ? 'kg'
                                    : (u === 'milliliter' || u === 'ml') ? 'ml'
                                    : (u.startsWith('liter') || u === 'l') ? 'l'
                                    : u;
                        packSize = `${packMatch[1]} ${uNorm}`.trim();
                        cleaned = cleaned.slice(packMatch[0].length).trim();
                    }

                    // Units + containers
                    const measurementUnits = [
                        'teaspoon','teaspoons','tsp',
                        'tablespoon','tablespoons','tbsp',
                        'cup','cups','c',
                        'ounce','ounces','oz',
                        'pound','pounds','lb','lbs',
                        'gram','grams','g',
                        'kilogram','kilograms','kg',
                        'milliliter','milliliters','ml',
                        'liter','liters','l'
                    ];
                    const containerUnits = [
                        'can','cans','jar','jars','bottle','bottles','package','packages','pkg','pkgs',
                        'bag','bags','box','boxes','bunch','bunches','head','heads','clove','cloves',
                        'slice','slices','stick','sticks','sprig','sprigs'
                    ];

                    // If the next word is a measurement unit, capture it (e.g., "14 oz")
                    const firstWord = (cleaned.split(' ')[0] || '').toLowerCase();
                    if(measurementUnits.includes(firstWord)) {
                        const u = firstWord;
                        unit = (u.startsWith('ounce') || u === 'oz') ? 'oz'
                             : (u.startsWith('pound') || u === 'lb' || u === 'lbs') ? 'lb'
                             : (u.startsWith('tablespoon') || u === 'tbsp') ? 'tbsp'
                             : (u.startsWith('teaspoon') || u === 'tsp') ? 'tsp'
                             : (u === 'c') ? 'cup'
                             : (u.startsWith('gram') || u === 'g') ? 'g'
                             : (u.startsWith('kilogram') || u === 'kg') ? 'kg'
                             : (u.startsWith('milliliter') || u === 'ml') ? 'ml'
                             : (u.startsWith('liter') || u === 'l') ? 'l'
                             : u;
                        cleaned = cleaned.split(' ').slice(1).join(' ').trim();
                    }

                    // If the next word is a container, capture it (e.g., "can", "jar")
                    const nextWord = (cleaned.split(' ')[0] || '').toLowerCase();
                    if(containerUnits.includes(nextWord)) {
                        container = nextWord === 'pkgs' ? 'pkg' : nextWord;
                        cleaned = cleaned.split(' ').slice(1).join(' ').trim();
                    }

                    // Remove optional "of"
                    cleaned = cleaned.replace(/^of\s+/i, '').trim();

                    // Ingredient name (what remains)
                    const item = cleaned.replace(/\s+/g, ' ').trim();
                    if(!item) return null;

                    // Display string: keep quantity + size + unit/container, but remove prep notes
                    let displayParts = [];
                    if(qty) displayParts.push(qty);
                    if(packSize) displayParts.push(packSize);
                    if(unit) displayParts.push(unit);
                    if(container) displayParts.push(container);

                    let display = '';
                    if(displayParts.length > 0) {
                        display = displayParts.join(' ');
                        // Use "of" after container/measurements when it reads naturally
                        const needsOf = container || unit || packSize;
                        display += needsOf ? ` of ${item}` : ` ${item}`;
                    } else {
                        display = item;
                    }
                    display = display.replace(/\s+/g, ' ').trim();

                    const key = normalizeIngredientForMatch(item);
                    return { raw, item, display, key };
                }

                // Backward-compatible helper (returns just the matching key)
                function parseIngredient(text) {
                    const obj = parseIngredientLine(text);
                    return obj ? obj.key : '';
                }

                function generateGroceryList() {
                    let needed = [];
                    Object.values(mealPlan).forEach(p => {
                        const r = recipes.find(x => x.id === p.recipeId);
                        if(r) {
                            (r.ingredients || '').split('\n').forEach(line => {
                                const parsed = parseIngredientLine(line);
                                if(parsed && parsed.key) needed.push(parsed);
                            });
                        }
                    });

                    // Compare against on-hand inventory using normalized matching keys (not exact strings).
                    // Compare against on-hand inventory using fuzzy token matching (not exact strings).
                    const onHandItems = inventory
                        .filter(i => i.checked)
                        .map(i => {
                            const p = parseIngredientLine(i.name);
                            if(!p || !p.key) return null;
                            return { key: p.key, tokens: tokenizeForMatch(p.item || p.display || p.key) };
                        })
                        .filter(Boolean);

                    const finalNeeded = needed.filter(n => !onHandItems.some(h => isOnHandMatch(n, h)));

                    // De-duplicate by normalized key while preserving a clean display string.
                    const uniqueMap = new Map();
                    finalNeeded.forEach(n => {
                        if(!uniqueMap.has(n.key)) uniqueMap.set(n.key, n);
                    });

                    const uniqueNeeded = Array.from(uniqueMap.values()).map(n => {
                        const display = n.display || n.item || n.raw || '';
                        const name = (/^\d/.test(display) || !display) ? display : (display.charAt(0).toUpperCase() + display.slice(1));
                        return {
                            name,
                            category: detectCategory(n.item || display),
                            isManual: false,
                            _key: n.key
                        };
                    });

                    const all = [...uniqueNeeded, ...manualGrocery];
                    const listEl = document.getElementById('grocery-list-output');
                    listEl.innerHTML = '';

                    if(all.length === 0) {
                        listEl.innerHTML = '<div style="padding:1rem; color:var(--text-light)">All stocked up!</div>';
                        return;
                    }

                    INVENTORY_CATEGORIES.forEach(cat => {
                        const items = all.filter(i => i.category === cat).sort((a,b)=>a.name.localeCompare(b.name));
                        if(items.length > 0) {
                            listEl.innerHTML += `<div class="inv-category-header">${cat}</div>`;
                            items.forEach(item => {
                                let del = '';
                                if(item.isManual) {
                                    const idx = manualGrocery.indexOf(item);
                                    del = `<i class="fas fa-times delete-manual" onclick="removeManualItem(${idx})"></i>`;
                                }
                                listEl.innerHTML += `
                                    <div class="grocery-item ${item.isManual?'manual-item':''}">
                                        <input type="checkbox"> <label>${item.name}</label> ${del}
                                    </div>
                                `;
                            });
                        }
                    });
                }


        window.copyGroceryList = () => {
            const listContainer = document.getElementById('grocery-list-output');
            const items = listContainer.querySelectorAll('.inv-category-header, .grocery-item label');
            let copyText = "GROCERY LIST:\n";
            items.forEach(el => {
                if(el.classList.contains('inv-category-header')) {
                    copyText += `\n[${el.innerText}]\n`;
                } else {
                    copyText += `- ${el.innerText}\n`;
                }
            });
            navigator.clipboard.writeText(copyText).then(() => {
                const btn = document.getElementById('btn-copy-list');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = `<i class="fas fa-check"></i> Copied!`;
                setTimeout(() => { btn.innerHTML = originalHtml; }, 2000);
            });
        };

        
        // --- COOK MODE (Fullscreen) with BIG CHECKLIST + STEP TIMERS ---
        const cookTimers = new Map();
        let cookModeEventsBound = false;

        function escapeHtml(str) {
            return String(str).replace(/[&<>"']/g, s => ({
                '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
            }[s]));
        }

        function formatTime(totalSeconds) {
            const s = Math.max(0, Math.floor(totalSeconds || 0));
            const hrs = Math.floor(s / 3600);
            const mins = Math.floor((s % 3600) / 60);
            const secs = s % 60;
            const pad2 = (n) => String(n).padStart(2, '0');
            return hrs > 0 ? `${hrs}:${pad2(mins)}:${pad2(secs)}` : `${pad2(mins)}:${pad2(secs)}`;
        }

        function parseDurationSeconds(text) {
            const t = (text || '').toLowerCase();

            // Ranges like "20-25 minutes" or "20 to 25 min" (use the upper bound)
            const range = t.match(/(\d+)\s*(?:-|to)\s*(\d+)\s*(hours?|hrs?|hr|h|minutes?|mins?|min|m|seconds?|secs?|sec|s)\b/);
            if (range) {
                const val = parseInt(range[2], 10);
                const unit = range[3];
                if (unit.startsWith('h')) return { seconds: val * 3600, label: range[0] };
                if (unit.startsWith('m')) return { seconds: val * 60, label: range[0] };
                return { seconds: val, label: range[0] };
            }

            const h = t.match(/(\d+)\s*(hours?|hrs?|hr|h)\b/);
            const m = t.match(/(\d+)\s*(minutes?|mins?|min|m)\b/);
            const s = t.match(/(\d+)\s*(seconds?|secs?|sec|s)\b/);

            const hours = h ? parseInt(h[1], 10) : 0;
            const minutes = m ? parseInt(m[1], 10) : 0;
            const seconds = s ? parseInt(s[1], 10) : 0;

            const total = hours * 3600 + minutes * 60 + seconds;
            if (total > 0) {
                const label = [h?.[0], m?.[0], s?.[0]].filter(Boolean).join(' ');
                return { seconds: total, label: label || '' };
            }
            return null;
        }

        function playTimerDoneSignal() {
            // Lightweight beep + optional vibration (safe no-op if unsupported)
            try {
                if (navigator.vibrate) navigator.vibrate([120, 80, 120]);
            } catch(e) {}
            try {
                const AudioCtx = window.AudioContext || window.webkitAudioContext;
                if (!AudioCtx) return;
                const ctx = new AudioCtx();
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.type = 'sine';
                o.frequency.value = 880;
                g.gain.value = 0.05;
                o.connect(g);
                g.connect(ctx.destination);
                o.start();
                setTimeout(() => { o.stop(); ctx.close(); }, 250);
            } catch(e) {}
        }

        function clearAllCookTimers() {
            cookTimers.forEach(state => {
                if (state.interval) clearInterval(state.interval);
            });
            cookTimers.clear();
        }

        function setTimerUI(timerId) {
            const state = cookTimers.get(timerId);
            if (!state) return;

            const wrap = document.querySelector(`.cook-timer[data-timer-id="${timerId}"]`);
            if (!wrap) return;

            const display = wrap.querySelector('.cook-timer-display');
            if (display) display.textContent = formatTime(state.remaining);

            wrap.classList.toggle('running', !!state.running);
            wrap.classList.toggle('finished', state.remaining === 0);
        }

        function startCookTimer(timerId) {
            const state = cookTimers.get(timerId);
            if (!state || state.running || state.remaining <= 0) return;

            state.running = true;
            setTimerUI(timerId);

            state.interval = setInterval(() => {
                state.remaining = Math.max(0, state.remaining - 1);
                setTimerUI(timerId);

                if (state.remaining === 0) {
                    pauseCookTimer(timerId);
                    showToast(`${state.label || 'Timer'} done`);
                    playTimerDoneSignal();
                }
            }, 1000);
        }

        function pauseCookTimer(timerId) {
            const state = cookTimers.get(timerId);
            if (!state) return;

            if (state.interval) clearInterval(state.interval);
            state.interval = null;
            state.running = false;
            setTimerUI(timerId);
        }

        function restartCookTimer(timerId) {
            const state = cookTimers.get(timerId);
            if (!state) return;

            pauseCookTimer(timerId);
            state.remaining = state.initial;
            setTimerUI(timerId);
        }

        function bindCookModeEvents() {
            if (cookModeEventsBound) return;
            cookModeEventsBound = true;

            const overlay = document.getElementById('cook-mode-overlay');
            if (!overlay) return;

            overlay.addEventListener('click', (e) => {
                // Timer buttons
                const btn = e.target.closest('[data-timer-action][data-timer-id]');
                if (btn) {
                    e.preventDefault();
                    e.stopPropagation();
                    const action = btn.dataset.timerAction;
                    const timerId = btn.dataset.timerId;
                    if (action === 'start') startCookTimer(timerId);
                    if (action === 'pause') pauseCookTimer(timerId);
                    if (action === 'restart') restartCookTimer(timerId);
                    return;
                }

                // Checklist toggle (ignore clicks inside timer area)
                if (e.target.closest('.cook-timer')) return;

                const toggle = e.target.closest('.cook-toggle');
                if (!toggle) return;

                const checkbox = toggle.querySelector('input[type="checkbox"]');
                if (!checkbox) return;

                // If user clicked the checkbox directly, let it toggle naturally and then sync styles.
                if (e.target === checkbox) {
                    toggle.classList.toggle('done', checkbox.checked);
                    return;
                }

                checkbox.checked = !checkbox.checked;
                toggle.classList.toggle('done', checkbox.checked);
            });
        }

        function safeId(str) {
            return String(str || '').replace(/[^a-z0-9_-]/gi, '_');
        }


        function createCookChecklistItem(text) {
            const item = document.createElement('div');
            item.className = 'cook-toggle';

            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.className = 'cook-checkbox';

            const span = document.createElement('span');
            span.className = 'cook-item-text';
            span.textContent = text;

            item.appendChild(cb);
            item.appendChild(span);
            return item;
        }

        function createTimerElement(timerId, initialSeconds) {
            const wrap = document.createElement('div');
            wrap.className = 'cook-timer';
            wrap.dataset.timerId = timerId;

            const display = document.createElement('div');
            display.className = 'cook-timer-display';
            display.textContent = formatTime(initialSeconds);

            const controls = document.createElement('div');
            controls.className = 'cook-timer-controls';

            const startBtn = document.createElement('button');
            startBtn.type = 'button';
            startBtn.className = 'timer-btn primary';
            startBtn.dataset.timerAction = 'start';
            startBtn.dataset.timerId = timerId;
            startBtn.innerHTML = `<i class="fas fa-play"></i> Start`;

            const pauseBtn = document.createElement('button');
            pauseBtn.type = 'button';
            pauseBtn.className = 'timer-btn';
            pauseBtn.dataset.timerAction = 'pause';
            pauseBtn.dataset.timerId = timerId;
            pauseBtn.innerHTML = `<i class="fas fa-pause"></i> Pause`;

            const restartBtn = document.createElement('button');
            restartBtn.type = 'button';
            restartBtn.className = 'timer-btn';
            restartBtn.dataset.timerAction = 'restart';
            restartBtn.dataset.timerId = timerId;
            restartBtn.innerHTML = `<i class="fas fa-rotate-left"></i> Restart`;

            controls.appendChild(startBtn);
            controls.appendChild(pauseBtn);
            controls.appendChild(restartBtn);

            wrap.appendChild(display);
            wrap.appendChild(controls);
            return wrap;
        }

        function createCookInstructionRow(stepText, stepIndex, recipeKey) {
            const row = document.createElement('div');
            row.className = 'cook-step-row';

            const main = document.createElement('div');
            main.className = 'cook-toggle cook-step-main';

            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.className = 'cook-checkbox';

            const num = document.createElement('div');
            num.className = 'cook-step-num';
            num.textContent = String(stepIndex + 1);

            const span = document.createElement('span');
            span.className = 'cook-item-text';
            span.textContent = stepText;

            main.appendChild(cb);
            main.appendChild(num);
            main.appendChild(span);

            row.appendChild(main);

            const dur = parseDurationSeconds(stepText);
            if (dur && dur.seconds >= 30) { // ignore very short times
                const timerId = `${safeId(recipeKey)}-step-${stepIndex}`;
                cookTimers.set(timerId, {
                    initial: dur.seconds,
                    remaining: dur.seconds,
                    interval: null,
                    running: false,
                    label: `Step ${stepIndex + 1}`
                });

                const timerEl = createTimerElement(timerId, dur.seconds);
                row.appendChild(timerEl);
                setTimerUI(timerId);
            }

            return row;
        }

        function openCookModeWithRecipeData(r, { scaledIngredientsHtml = null, recipeKey = null } = {}) {
            if (!r) return;

            bindCookModeEvents();
            clearAllCookTimers();

            const title = (r.title || '').trim();
            document.getElementById('cook-title').innerText = title || 'Recipe';

            const ingContainer = document.getElementById('cook-ingredients');
            const instContainer = document.getElementById('cook-instructions');
            ingContainer.innerHTML = '';
            instContainer.innerHTML = '';

            // Ingredients
            let ingLines = [];
            if (scaledIngredientsHtml) {
                const temp = document.createElement('div');
                temp.innerHTML = scaledIngredientsHtml;
                ingLines = Array.from(temp.querySelectorAll('li')).map(li => li.textContent.trim()).filter(Boolean);
            } else {
                ingLines = (r.ingredients || '').split('\n').map(x => x.trim()).filter(Boolean);
            }
            ingLines.forEach(line => ingContainer.appendChild(createCookChecklistItem(line)));

            // Instructions (one per line)
            const steps = (r.instructions || '').split('\n').map(x => x.trim()).filter(Boolean);
            const key = safeId(recipeKey || (r.id ? `recipe-${r.id}` : `recipe-${Date.now()}`));
            steps.forEach((step, idx) => instContainer.appendChild(createCookInstructionRow(step, idx, key)));

            document.getElementById('cook-mode-overlay').classList.add('active');

            // Keep screen awake while cooking
            try {
                if ('wakeLock' in navigator) navigator.wakeLock.request('screen').then(w => wakeLock = w);
            } catch(e) {}
        }

        window.openCookMode = (id) => {
            const r = recipes.find(x => x.id == id);
            if (!r) return;

            const currentMult = r.currentMultiplier || 1.0;
            const scaledHtml = formatScaledIngredients(r.ingredients, currentMult);
            openCookModeWithRecipeData(r, { scaledIngredientsHtml: scaledHtml, recipeKey: `recipe-${r.id}` });
        };

        // Opens Cook Mode using a recipe object (used for read-only / friend recipes)
        window.openCookModeFromData = (r) => {
            openCookModeWithRecipeData(r, { recipeKey: safeId(`friend-${r.id || (r.title || 'recipe')}`) });
        };

        window.closeCookMode = () => {
            document.getElementById('cook-mode-overlay').classList.remove('active');
            clearAllCookTimers();
            if (wakeLock) wakeLock.release().then(() => wakeLock = null);
        };


    </script>
</body>
</html>


